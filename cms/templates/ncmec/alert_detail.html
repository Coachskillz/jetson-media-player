{% extends "base.html" %}

{% block title %}Alert #{{ alert.id }} - NCMEC Review{% endblock %}

{% block extra_styles %}
.back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: white;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 20px;
    opacity: 0.9;
    transition: all 0.2s;
}

.back-link:hover {
    opacity: 1;
    transform: translateX(-4px);
}

.alert-header {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.alert-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.alert-title {
    font-size: 24px;
    font-weight: 700;
    color: #1e293b;
}

.alert-status-badge {
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
}

.alert-status-badge.pending { background: #fef3c7; color: #92400e; }
.alert-status-badge.reviewing { background: #e0e7ff; color: #3730a3; }
.alert-status-badge.confirmed { background: #fee2e2; color: #991b1b; }
.alert-status-badge.reported { background: #d1fae5; color: #065f46; }
.alert-status-badge.dismissed { background: #f1f5f9; color: #64748b; }

.comparison-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.image-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.image-card h3 {
    font-size: 16px;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.image-card img {
    width: 100%;
    border-radius: 12px;
    background: #f1f5f9;
}

.confidence-meter {
    margin-top: 15px;
    padding: 15px;
    background: #f8fafc;
    border-radius: 10px;
}

.confidence-label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 13px;
    font-weight: 600;
}

.confidence-bar {
    height: 10px;
    background: #e2e8f0;
    border-radius: 5px;
    overflow: hidden;
}

.confidence-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 0.5s ease;
}

.confidence-fill.high { background: linear-gradient(90deg, #ef4444, #dc2626); }
.confidence-fill.medium { background: linear-gradient(90deg, #f59e0b, #d97706); }
.confidence-fill.low { background: linear-gradient(90deg, #3b82f6, #2563eb); }

.details-section {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.details-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

.detail-item {
    padding: 15px;
    background: #f8fafc;
    border-radius: 10px;
}

.detail-label {
    font-size: 12px;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    margin-bottom: 5px;
}

.detail-value {
    font-size: 15px;
    font-weight: 600;
    color: #1e293b;
}

.actions-section {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.actions-section h3 {
    font-size: 18px;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 20px;
}

.action-buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.action-btn {
    padding: 15px 30px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.action-btn.confirm {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.action-btn.report {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.action-btn.dismiss {
    background: #f1f5f9;
    color: #64748b;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.notes-input {
    width: 100%;
    padding: 15px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 14px;
    margin-bottom: 15px;
    resize: vertical;
    min-height: 80px;
}

.notes-input:focus {
    outline: none;
    border-color: #667eea;
}

.report-fields {
    display: none;
    margin-top: 15px;
    padding: 20px;
    background: #f8fafc;
    border-radius: 10px;
}

.report-fields.active {
    display: block;
}

.report-fields input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    margin-bottom: 10px;
}

.report-fields input:focus {
    outline: none;
    border-color: #667eea;
}

.audit-log {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
}

.audit-log h4 {
    font-size: 14px;
    font-weight: 600;
    color: #64748b;
    margin-bottom: 10px;
}

.audit-item {
    font-size: 13px;
    color: #64748b;
    padding: 8px 0;
    border-bottom: 1px solid #f1f5f9;
}

@media (max-width: 768px) {
    .comparison-section {
        grid-template-columns: 1fr;
    }
    .details-grid {
        grid-template-columns: 1fr;
    }
}
{% endblock %}

{% block content %}
<a href="/ncmec/alerts" class="back-link">
    <span>‚Üê</span> Back to Alerts
</a>

<div class="alert-header">
    <div class="alert-header-row">
        <div class="alert-title">üö® Alert #{{ alert.id }} - Case {{ alert.ncmec_case_id }}</div>
        <div class="alert-status-badge {{ alert.status }}">{{ alert.status }}</div>
    </div>
</div>

<div class="comparison-section">
    <div class="image-card">
        <h3>üì∑ Captured Image</h3>
        <img src="{{ alert.captured_image_path or '/static/placeholder.png' }}" alt="Captured Image">
        <div class="confidence-meter">
            <div class="confidence-label">
                <span>Match Confidence</span>
                <span id="confidenceValue">{{ (alert.confidence_score * 100)|round|int }}%</span>
            </div>
            <div class="confidence-bar">
                <div class="confidence-fill {% if alert.confidence_score >= 0.9 %}high{% elif alert.confidence_score >= 0.8 %}medium{% else %}low{% endif %}" 
                     style="width: {{ (alert.confidence_score * 100)|round|int }}%"></div>
            </div>
        </div>
    </div>
    
    <div class="image-card">
        <h3>üìã NCMEC Case Photo</h3>
        {% if alert.ncmec_case_photo_path %}
        <img src="{{ alert.ncmec_case_photo_path }}" alt="NCMEC Case Photo">
        {% else %}
        <div style="padding: 60px; text-align: center; background: #f1f5f9; border-radius: 12px;">
            <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
            <div style="color: #64748b;">Case photo not available</div>
        </div>
        {% endif %}
        {% if alert.ncmec_child_name %}
        <div style="margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 10px;">
            <div class="detail-label">Child Name</div>
            <div class="detail-value">{{ alert.ncmec_child_name }}</div>
        </div>
        {% endif %}
    </div>
</div>

<div class="details-section">
    <h3 style="font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 20px;">Detection Details</h3>
    <div class="details-grid">
        <div class="detail-item">
            <div class="detail-label">Location</div>
            <div class="detail-value">{{ alert.store_name or 'Unknown' }}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Address</div>
            <div class="detail-value">{{ alert.store_address or 'Unknown' }}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Device ID</div>
            <div class="detail-value">{{ alert.device_id }}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Detected At</div>
            <div class="detail-value">{{ alert.detected_at.strftime('%Y-%m-%d %H:%M:%S') if alert.detected_at else 'Unknown' }}</div>
        </div>
    </div>
</div>

<div class="actions-section">
    <h3>Take Action</h3>
    
    <textarea class="notes-input" id="reviewNotes" placeholder="Add notes about this alert...">{{ alert.review_notes or '' }}</textarea>
    
    <div class="report-fields" id="reportFields">
        <input type="text" id="reportedTo" placeholder="Reported to (e.g., NCMEC Hotline, Local Police)" value="{{ alert.reported_to or '' }}">
        <input type="text" id="reportReference" placeholder="Reference number (optional)" value="{{ alert.report_reference or '' }}">
    </div>
    
    <div class="action-buttons">
        {% if alert.status == 'pending' %}
        <button class="action-btn confirm" onclick="confirmAlert()">
            ‚ö†Ô∏è Confirm Match
        </button>
        <button class="action-btn dismiss" onclick="dismissAlert()">
            ‚ùå Dismiss as False Positive
        </button>
        {% elif alert.status == 'reviewing' or alert.status == 'confirmed' %}
        <button class="action-btn report" onclick="showReportFields()">
            üìû Mark as Reported
        </button>
        <button class="action-btn dismiss" onclick="dismissAlert()">
            ‚ùå Dismiss as False Positive
        </button>
        {% elif alert.status == 'reported' %}
        <button class="action-btn" disabled style="background: #d1fae5; color: #065f46;">
            ‚úÖ Reported to Authorities
        </button>
        {% elif alert.status == 'dismissed' %}
        <button class="action-btn" disabled style="background: #f1f5f9; color: #64748b;">
            Dismissed
        </button>
        {% endif %}
    </div>
    
    {% if alert.reviewed_by or alert.reported_at %}
    <div class="audit-log">
        <h4>Activity Log</h4>
        {% if alert.reviewed_at %}
        <div class="audit-item">
            Reviewed on {{ alert.reviewed_at.strftime('%Y-%m-%d %H:%M') }} 
            {% if alert.reviewed_by %}by {{ alert.reviewed_by.username }}{% endif %}
        </div>
        {% endif %}
        {% if alert.reported_at %}
        <div class="audit-item">
            Reported on {{ alert.reported_at.strftime('%Y-%m-%d %H:%M') }}
            {% if alert.reported_to %} to {{ alert.reported_to }}{% endif %}
            {% if alert.report_reference %} (Ref: {{ alert.report_reference }}){% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const alertId = {{ alert.id }};

function showReportFields() {
    document.getElementById('reportFields').classList.add('active');
}

async function confirmAlert() {
    const notes = document.getElementById('reviewNotes').value;
    
    try {
        const response = await fetch(`/api/v1/ncmec/alerts/${alertId}/confirm`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ notes })
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert('Error: ' + (data.error || 'Failed to confirm alert'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function dismissAlert() {
    const reason = document.getElementById('reviewNotes').value || 'Dismissed as false positive';
    
    if (!confirm('Are you sure you want to dismiss this alert as a false positive?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/ncmec/alerts/${alertId}/dismiss`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ reason })
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert('Error: ' + (data.error || 'Failed to dismiss alert'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function reportAlert() {
    const notes = document.getElementById('reviewNotes').value;
    const reportedTo = document.getElementById('reportedTo').value;
    const reference = document.getElementById('reportReference').value;
    
    if (!reportedTo) {
        alert('Please enter who the alert was reported to');
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/ncmec/alerts/${alertId}/report`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ 
                notes,
                reported_to: reportedTo,
                reference
            })
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert('Error: ' + (data.error || 'Failed to mark as reported'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Update the report button to actually submit
document.querySelector('.action-btn.report')?.addEventListener('click', function(e) {
    if (document.getElementById('reportFields').classList.contains('active')) {
        e.preventDefault();
        reportAlert();
    }
});
</script>
{% endblock %}
