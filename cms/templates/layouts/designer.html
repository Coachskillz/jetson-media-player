{% extends "base.html" %}

{% block title %}Layout Designer - {{ layout.name }} - Skillz Media Screens CMS{% endblock %}

{% block extra_styles %}
/* Layout Designer - Full Screen Mode */
body {
    background: #0a0a10;
    min-height: 100vh;
    overflow: hidden;
}

.header {
    background: rgba(10, 10, 16, 0.95);
    border-bottom: 1px solid #333;
    padding: 10px 20px;
}

.header .container {
    max-width: none;
    padding: 0;
}

.header h1 {
    font-size: 20px;
    margin-bottom: 0;
}

.header .nav {
    margin-top: 10px;
}

.container {
    max-width: none;
    padding: 0;
}

/* Hide footer in designer mode */
.footer {
    display: none;
}

/* Designer Layout */
.designer-wrapper {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 80px);
    background: #050508;
}

/* Toolbar */
.designer-toolbar {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 20px;
    background: rgba(10, 10, 16, 0.95);
    border-bottom: 1px solid #333;
    flex-shrink: 0;
}

.toolbar-group {
    display: flex;
    align-items: center;
    gap: 8px;
    padding-right: 16px;
    border-right: 1px solid #333;
}

.toolbar-group:last-child {
    border-right: none;
}

.toolbar-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid #333;
    color: #888;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s;
}

.toolbar-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    border-color: #444;
}

.toolbar-btn.active {
    background: linear-gradient(135deg, #00D4AA 0%, #00B090 100%);
    color: #050508;
    border-color: #00D4AA;
}

.toolbar-btn-text {
    width: auto;
    padding: 0 16px;
    font-size: 14px;
    font-weight: 500;
    gap: 8px;
}

.toolbar-label {
    color: #888;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-right: 8px;
}

.toolbar-select {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid #333;
    border-radius: 8px;
    color: #fff;
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    min-width: 100px;
}

.toolbar-select:hover {
    border-color: #444;
}

.toolbar-select:focus {
    outline: none;
    border-color: #00D4AA;
}

.toolbar-spacer {
    flex-grow: 1;
}

.btn-save {
    background: linear-gradient(135deg, #00D4AA 0%, #00B090 100%);
    color: #050508;
    font-weight: 600;
    box-shadow: 0 4px 16px rgba(0, 212, 170, 0.3);
}

.btn-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 212, 170, 0.4);
}

/* Main Designer Area */
.designer-main {
    display: flex;
    flex-grow: 1;
    overflow: hidden;
}

/* Left Panel - Layer List */
.panel-left {
    width: 280px;
    background: rgba(10, 10, 16, 0.95);
    border-right: 1px solid #333;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
}

.panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    border-bottom: 1px solid #333;
}

.panel-title {
    color: #fff;
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.panel-action {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 6px;
    background: rgba(0, 212, 170, 0.1);
    border: 1px solid rgba(0, 212, 170, 0.3);
    color: #00D4AA;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
}

.panel-action:hover {
    background: rgba(0, 212, 170, 0.2);
    border-color: #00D4AA;
}

.panel-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 8px;
}

/* Layer List */
.layer-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.layer-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.layer-item:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: #333;
}

.layer-item.selected {
    background: rgba(0, 212, 170, 0.1);
    border-color: #00D4AA;
}

.layer-visibility {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    color: #666;
    font-size: 14px;
    cursor: pointer;
    transition: color 0.2s;
}

.layer-visibility:hover {
    color: #888;
}

.layer-visibility.visible {
    color: #00D4AA;
}

.layer-preview {
    width: 40px;
    height: 30px;
    background: #1a1a24;
    border: 1px solid #333;
    border-radius: 4px;
    flex-shrink: 0;
}

.layer-info {
    flex-grow: 1;
    min-width: 0;
}

.layer-name {
    color: #fff;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.layer-dims {
    color: #666;
    font-size: 11px;
    margin-top: 2px;
}

.layer-lock {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    color: #444;
    font-size: 12px;
    cursor: pointer;
    transition: color 0.2s;
}

.layer-lock:hover {
    color: #666;
}

.layer-lock.locked {
    color: #ff6b6b;
}

/* Empty Layer State */
.layers-empty {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.layers-empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.layers-empty-text {
    font-size: 14px;
    line-height: 1.6;
}

/* Canvas Container */
.canvas-container {
    flex-grow: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: auto;
    background: #050508;
    position: relative;
}

/* Checkerboard Pattern for Transparency */
.canvas-wrapper {
    position: relative;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.canvas-checkerboard {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image:
        linear-gradient(45deg, #333 25%, transparent 25%),
        linear-gradient(-45deg, #333 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #333 75%),
        linear-gradient(-45deg, transparent 75%, #333 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0;
    background-color: #222;
    pointer-events: none;
}

#layout-canvas {
    position: relative;
    z-index: 1;
}

/* Right Panel - Properties */
.panel-right {
    width: 320px;
    background: rgba(10, 10, 16, 0.95);
    border-left: 1px solid #333;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
}

/* Properties Panel Sections */
.properties-section {
    border-bottom: 1px solid #333;
    padding: 16px;
}

.properties-section:last-child {
    border-bottom: none;
}

.section-title {
    color: #888;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
}

/* Property Row */
.property-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}

.property-row:last-child {
    margin-bottom: 0;
}

.property-label {
    color: #888;
    font-size: 12px;
    font-weight: 500;
    min-width: 50px;
}

.property-input {
    flex-grow: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid #333;
    border-radius: 6px;
    color: #fff;
    padding: 8px 10px;
    font-size: 13px;
    font-family: 'Monaco', 'Menlo', monospace;
}

.property-input:hover {
    border-color: #444;
}

.property-input:focus {
    outline: none;
    border-color: #00D4AA;
    background: rgba(255, 255, 255, 0.08);
}

.property-input-sm {
    width: 70px;
    flex-grow: 0;
}

.property-group {
    display: flex;
    gap: 8px;
}

/* Color Picker Wrapper */
.color-picker-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}

.color-preview {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: 1px solid #333;
    cursor: pointer;
    transition: border-color 0.2s;
}

.color-preview:hover {
    border-color: #444;
}

/* Slider */
.property-slider {
    flex-grow: 1;
    -webkit-appearance: none;
    height: 6px;
    background: #333;
    border-radius: 3px;
    outline: none;
}

.property-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: #00D4AA;
    border-radius: 50%;
    cursor: pointer;
}

.property-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: #00D4AA;
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

/* Select Dropdown */
.property-select {
    flex-grow: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid #333;
    border-radius: 6px;
    color: #fff;
    padding: 8px 10px;
    font-size: 13px;
    cursor: pointer;
}

.property-select:hover {
    border-color: #444;
}

.property-select:focus {
    outline: none;
    border-color: #00D4AA;
}

/* Content Assignment */
.content-mode-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 12px;
}

.content-mode-tab {
    flex: 1;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid #333;
    border-radius: 6px;
    color: #888;
    font-size: 12px;
    font-weight: 500;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}

.content-mode-tab:hover {
    background: rgba(255, 255, 255, 0.08);
    color: #fff;
}

.content-mode-tab.active {
    background: rgba(0, 212, 170, 0.15);
    border-color: #00D4AA;
    color: #00D4AA;
}

.content-preview {
    background: #1a1a24;
    border: 1px dashed #333;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    color: #666;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}

.content-preview:hover {
    border-color: #00D4AA;
    background: rgba(0, 212, 170, 0.05);
}

.content-preview-icon {
    font-size: 32px;
    margin-bottom: 8px;
}

/* Button Styles in Panels */
.panel-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid #333;
    border-radius: 6px;
    color: #888;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.panel-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    border-color: #444;
}

.panel-btn-group {
    display: flex;
    gap: 4px;
}

.panel-btn-icon {
    flex: 1;
    justify-content: center;
}

/* No Selection State */
.no-selection {
    padding: 40px 20px;
    text-align: center;
    color: #666;
}

.no-selection-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.no-selection-text {
    font-size: 14px;
    line-height: 1.6;
}

/* Canvas Info Bar */
.canvas-info {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 8px 16px;
    background: rgba(10, 10, 16, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid #333;
    border-radius: 8px;
    color: #888;
    font-size: 12px;
    z-index: 10;
}

.canvas-info-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.canvas-info-label {
    color: #666;
}

.canvas-info-value {
    color: #00D4AA;
    font-family: 'Monaco', 'Menlo', monospace;
}

/* Scrollbar Styling */
.panel-content::-webkit-scrollbar {
    width: 8px;
}

.panel-content::-webkit-scrollbar-track {
    background: transparent;
}

.panel-content::-webkit-scrollbar-thumb {
    background: #333;
    border-radius: 4px;
}

.panel-content::-webkit-scrollbar-thumb:hover {
    background: #444;
}

/* Responsive - Hide Panels on Small Screens */
@media (max-width: 1200px) {
    .panel-right {
        width: 280px;
    }
}

@media (max-width: 900px) {
    .panel-left, .panel-right {
        display: none;
    }
}
{% endblock %}

{% block content %}
<div class="designer-wrapper">
    <!-- Toolbar -->
    <div class="designer-toolbar">
        <div class="toolbar-group">
            <a href="/layouts" class="toolbar-btn toolbar-btn-text" title="Back to Layouts">
                <span>&#8592;</span> Back
            </a>
        </div>

        <div class="toolbar-group">
            <span class="toolbar-label">Tool</span>
            <button class="toolbar-btn active" id="tool-select" title="Select Tool (V)">
                <span>&#9654;</span>
            </button>
            <button class="toolbar-btn" id="tool-draw" title="Draw Layer (D)">
                <span>&#9633;</span>
            </button>
        </div>

        <div class="toolbar-group">
            <span class="toolbar-label">Zoom</span>
            <button class="toolbar-btn" id="zoom-out" title="Zoom Out (-)">
                <span>&#8722;</span>
            </button>
            <select class="toolbar-select" id="zoom-level">
                <option value="0.25">25%</option>
                <option value="0.50">50%</option>
                <option value="0.75">75%</option>
                <option value="1.00" selected>100%</option>
                <option value="1.50">150%</option>
                <option value="2.00">200%</option>
            </select>
            <button class="toolbar-btn" id="zoom-in" title="Zoom In (+)">
                <span>&#43;</span>
            </button>
            <button class="toolbar-btn" id="zoom-fit" title="Fit to Window">
                <span>&#8596;</span>
            </button>
        </div>

        <div class="toolbar-group">
            <span class="toolbar-label">Layer</span>
            <button class="toolbar-btn" id="layer-front" title="Bring to Front">
                <span>&#8593;</span>
            </button>
            <button class="toolbar-btn" id="layer-back" title="Send to Back">
                <span>&#8595;</span>
            </button>
            <button class="toolbar-btn" id="layer-delete" title="Delete Layer (Del)">
                <span>&#128465;</span>
            </button>
        </div>

        <div class="toolbar-spacer"></div>

        <div class="toolbar-group">
            <span class="toolbar-label">Canvas</span>
            <span id="canvas-dimensions" style="color: #888; font-size: 13px;">
                {{ layout.canvas_width }}x{{ layout.canvas_height }}
            </span>
        </div>

        <div class="toolbar-group" style="border-right: none;">
            <button class="toolbar-btn toolbar-btn-text btn-save" id="save-layout">
                <span>&#128190;</span> Save
            </button>
        </div>
    </div>

    <!-- Main Designer Area -->
    <div class="designer-main">
        <!-- Left Panel - Layers -->
        <div class="panel-left">
            <div class="panel-header">
                <span class="panel-title">Layers</span>
                <button class="panel-action" id="add-layer" title="Add Layer">
                    <span>&#43;</span>
                </button>
            </div>
            <div class="panel-content">
                <div class="layer-list" id="layer-list">
                    <!-- Layer items will be rendered by JavaScript -->
                </div>

                <!-- Empty state placeholder -->
                <div class="layers-empty" id="layers-empty">
                    <div class="layers-empty-icon">&#128195;</div>
                    <div class="layers-empty-text">
                        No layers yet.<br>
                        Click <strong>Draw</strong> to create a layer or use the <strong>+</strong> button above.
                    </div>
                </div>
            </div>
        </div>

        <!-- Canvas Container -->
        <div class="canvas-container" id="canvas-container">
            <div class="canvas-wrapper" id="canvas-wrapper">
                <div class="canvas-checkerboard" id="canvas-checkerboard"
                     style="width: {{ layout.canvas_width }}px; height: {{ layout.canvas_height }}px;"></div>
                <canvas id="layout-canvas"></canvas>
            </div>

            <!-- Canvas Info Bar -->
            <div class="canvas-info">
                <div class="canvas-info-item">
                    <span class="canvas-info-label">Position:</span>
                    <span class="canvas-info-value" id="info-position">--, --</span>
                </div>
                <div class="canvas-info-item">
                    <span class="canvas-info-label">Size:</span>
                    <span class="canvas-info-value" id="info-size">-- x --</span>
                </div>
                <div class="canvas-info-item">
                    <span class="canvas-info-label">Zoom:</span>
                    <span class="canvas-info-value" id="info-zoom">100%</span>
                </div>
            </div>
        </div>

        <!-- Right Panel - Properties -->
        <div class="panel-right">
            <div class="panel-header">
                <span class="panel-title">Properties</span>
            </div>
            <div class="panel-content" id="properties-panel">
                <!-- No selection state -->
                <div class="no-selection" id="no-selection">
                    <div class="no-selection-icon">&#128204;</div>
                    <div class="no-selection-text">
                        Select a layer to edit its properties.
                    </div>
                </div>

                <!-- Layer Properties (hidden by default) -->
                <div id="layer-properties" style="display: none;">
                    <!-- Position & Size -->
                    <div class="properties-section">
                        <div class="section-title">Position & Size</div>
                        <div class="property-row">
                            <span class="property-label">X</span>
                            <input type="number" class="property-input property-input-sm" id="prop-x" value="0">
                            <span class="property-label">Y</span>
                            <input type="number" class="property-input property-input-sm" id="prop-y" value="0">
                        </div>
                        <div class="property-row">
                            <span class="property-label">W</span>
                            <input type="number" class="property-input property-input-sm" id="prop-width" value="400" min="20">
                            <span class="property-label">H</span>
                            <input type="number" class="property-input property-input-sm" id="prop-height" value="300" min="20">
                        </div>
                    </div>

                    <!-- Appearance -->
                    <div class="properties-section">
                        <div class="section-title">Appearance</div>
                        <div class="property-row">
                            <span class="property-label">Opacity</span>
                            <input type="range" class="property-slider" id="prop-opacity" min="0" max="100" value="100">
                            <input type="number" class="property-input property-input-sm" id="prop-opacity-value" value="100" min="0" max="100">
                        </div>
                        <div class="property-row">
                            <span class="property-label">Background</span>
                            <div class="color-picker-wrapper">
                                <input type="text" class="property-input" id="prop-background" value="transparent" placeholder="transparent">
                            </div>
                        </div>
                        <div class="property-row">
                            <span class="property-label">Border</span>
                            <input type="number" class="property-input property-input-sm" id="prop-border-width" value="0" min="0" max="20">
                            <input type="text" class="property-input" id="prop-border-color" value="#333333">
                        </div>
                        <div class="property-row">
                            <span class="property-label">Radius</span>
                            <input type="number" class="property-input property-input-sm" id="prop-border-radius" value="0" min="0" max="100">
                        </div>
                    </div>

                    <!-- Layer Options -->
                    <div class="properties-section">
                        <div class="section-title">Layer Options</div>
                        <div class="property-row">
                            <span class="property-label">Name</span>
                            <input type="text" class="property-input" id="prop-name" value="" placeholder="Layer name">
                        </div>
                        <div class="property-row">
                            <span class="property-label">Fit Mode</span>
                            <select class="property-select" id="prop-fit-mode">
                                <option value="cover">Cover</option>
                                <option value="contain">Contain</option>
                                <option value="fill">Fill</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                        <div class="property-row">
                            <span class="property-label">Z-Index</span>
                            <input type="number" class="property-input property-input-sm" id="prop-z-index" value="0" readonly>
                            <div class="panel-btn-group">
                                <button class="panel-btn panel-btn-icon" id="prop-z-up" title="Bring Forward">&#8593;</button>
                                <button class="panel-btn panel-btn-icon" id="prop-z-down" title="Send Backward">&#8595;</button>
                            </div>
                        </div>
                    </div>

                    <!-- Content Assignment -->
                    <div class="properties-section">
                        <div class="section-title">Content</div>
                        <div class="content-mode-tabs">
                            <button class="content-mode-tab active" data-mode="static">Static</button>
                            <button class="content-mode-tab" data-mode="playlist">Playlist</button>
                        </div>
                        <div id="content-static">
                            <div class="content-preview" id="content-file-picker">
                                <div class="content-preview-icon">&#128194;</div>
                                <div>Click to select file</div>
                            </div>
                        </div>
                        <div id="content-playlist" style="display: none;">
                            <div class="content-preview playlist-preview" id="content-playlist-picker">
                                <div class="content-preview-icon">ðŸŽ¬</div>
                                <div>Click to assign playlists</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- jQuery (required for Spectrum color picker) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<!-- Fabric.js for canvas manipulation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

<!-- Spectrum Color Picker v2 (maintained fork with alpha support) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/spectrum-colorpicker2@2.0.10/dist/spectrum.min.css">
<script src="https://cdn.jsdelivr.net/npm/spectrum-colorpicker2@2.0.10/dist/spectrum.min.js"></script>

<script>
    // Layout data from server
    window.LAYOUT_DATA = {
        id: {{ layout.id }},
        name: "{{ layout.name }}",
        canvasWidth: {{ layout.canvas_width }},
        canvasHeight: {{ layout.canvas_height }},
        backgroundType: "{{ layout.background_type or 'solid' }}",
        backgroundColor: "{{ layout.background_color or '#000000' }}",
        backgroundOpacity: {{ layout.background_opacity or 1.0 }},
        layers: {{ layers|tojson|safe }}
    };

    // API Endpoints
    window.API_ENDPOINTS = {
        layout: "/api/v1/layouts/{{ layout.id }}",
        layers: "/api/v1/layouts/{{ layout.id }}/layers",
        reorder: "/api/v1/layouts/{{ layout.id }}/layers/reorder"
    };
</script>

<!-- Fabric Extensions (custom behaviors) -->
<script src="{{ url_for('static', filename='js/fabric-extensions.js') }}"></script>

<!-- Layer Panel -->
<script src="{{ url_for('static', filename='js/layer-panel.js') }}"></script>

<!-- Properties Panel -->
<script src="{{ url_for('static', filename='js/properties-panel.js') }}"></script>

<!-- Layout Designer -->
<script src="{{ url_for('static', filename='js/layout-designer.js') }}"></script>
{% endblock %}
