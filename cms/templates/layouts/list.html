{% extends "base.html" %}

{% block title %}Layouts - Skillz Media Screens CMS{% endblock %}

{% block extra_styles %}
.layout {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 20px;
    margin-top: 20px;
}

.main-content {
    min-width: 0;
}

.sidebar {
    position: sticky;
    top: 20px;
    height: fit-content;
}

.create-box {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.create-box h3 {
    font-size: 18px;
    color: #1e293b;
    margin-bottom: 20px;
    font-weight: 700;
}

.form-group {
    margin: 15px 0;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #475569;
    font-weight: 600;
    font-size: 14px;
}

.form-group input, .form-group textarea, .form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 14px;
    transition: all 0.2s;
}

.form-group input:focus, .form-group textarea:focus, .form-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 70px;
}

.dimension-inputs {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 10px;
    align-items: center;
}

.dimension-inputs span {
    text-align: center;
    color: #64748b;
    font-weight: 600;
}

.btn-success {
    background: #10b981;
    color: white;
}

.layouts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
}

.layout-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s;
    overflow: hidden;
}

.layout-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.layout-thumbnail {
    position: relative;
    background: #0a0a10;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    overflow: hidden;
}

.layout-thumbnail.portrait {
    padding-bottom: 177.78%; /* 9:16 aspect ratio */
}

.layout-thumbnail-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #050508;
}

.layout-thumbnail-placeholder {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    color: #64748b;
}

.layout-thumbnail-placeholder svg {
    width: 48px;
    height: 48px;
    opacity: 0.5;
}

.layout-thumbnail-placeholder span {
    font-size: 12px;
}

.layout-dimensions-badge {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
}

.layout-info {
    padding: 20px;
}

.layout-title {
    font-size: 18px;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 8px;
}

.layout-description {
    color: #64748b;
    font-size: 14px;
    margin-bottom: 12px;
    line-height: 1.5;
}

.layout-meta {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 15px;
}

.layout-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
}

.layout-badge.landscape {
    background: #e0e7ff;
    color: #3730a3;
}

.layout-badge.portrait {
    background: #fce7f3;
    color: #831843;
}

.layout-badge.template {
    background: #d1fae5;
    color: #065f46;
}

.layout-badge.layers {
    background: #fef3c7;
    color: #92400e;
}

.layout-actions {
    display: flex;
    gap: 10px;
    padding-top: 15px;
    border-top: 1px solid #e2e8f0;
}

.layout-actions .btn {
    flex: 1;
    justify-content: center;
    padding: 10px;
    font-size: 13px;
}

.templates-section {
    margin-bottom: 30px;
}

.templates-section h3 {
    color: white;
    font-size: 18px;
    margin-bottom: 15px;
    font-weight: 700;
}

.templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
}

.template-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.template-card:hover {
    transform: translateY(-2px);
    border-color: #667eea;
}

.template-card.selected {
    border-color: #667eea;
    background: #e0e7ff;
}

.template-icon {
    font-size: 32px;
    margin-bottom: 10px;
}

.template-name {
    font-weight: 600;
    color: #1e293b;
    font-size: 14px;
}

#createStatus {
    margin-top: 15px;
    padding: 12px;
    border-radius: 10px;
    display: none;
    font-size: 14px;
    font-weight: 500;
}

.info-box {
    background: #e0e7ff;
    border-left: 4px solid #667eea;
    padding: 15px 20px;
    border-radius: 12px;
    margin: 20px 0;
}

.info-box p {
    color: #3730a3;
    font-size: 14px;
    line-height: 1.6;
    margin: 5px 0;
}

@media (max-width: 1200px) {
    .layout {
        grid-template-columns: 1fr;
    }

    .sidebar {
        position: static;
    }
}
{% endblock %}

{% block content %}
<h2 style="margin: 20px 0 15px 0; color: white; font-size: 24px; font-weight: 700;">Screen Layouts</h2>

<div class="info-box">
    <p><strong>Screen Layout Designer:</strong> Create custom screen layouts with multiple layers.</p>
    <p>Draw regions, add content, and assign layouts to devices for dynamic signage.</p>
</div>

<div class="layout">
    <div class="main-content">
        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: white; font-weight: 700;">All Layouts ({{ layouts|length }})</h3>

        {% if layouts %}
        <div class="layouts-grid" id="layoutsGrid">
            {% for layout in layouts %}
            <div class="layout-card" data-layout-id="{{ layout.id }}">
                <div class="layout-thumbnail {% if layout.orientation == 'portrait' %}portrait{% endif %}">
                    {% if layout.thumbnail_path %}
                    <img src="{{ layout.thumbnail_path }}" alt="{{ layout.name }}" class="layout-thumbnail-image">
                    {% else %}
                    <div class="layout-thumbnail-placeholder">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
                        </svg>
                        <span>No preview</span>
                    </div>
                    {% endif %}
                    <div class="layout-dimensions-badge">{{ layout.canvas_width }} x {{ layout.canvas_height }}</div>
                </div>
                <div class="layout-info">
                    <div class="layout-title">{{ layout.name }}</div>
                    <div class="layout-description">{{ layout.description or 'No description' }}</div>
                    <div class="layout-meta">
                        <span class="layout-badge {{ layout.orientation }}">
                            {% if layout.orientation == 'landscape' %}Landscape{% else %}Portrait{% endif %}
                        </span>
                        {% if layout.is_template %}
                        <span class="layout-badge template">Template</span>
                        {% endif %}
                        <span class="layout-badge layers">{{ layout.layer_count or 0 }} layers</span>
                    </div>
                    <div class="layout-actions">
                        <a href="/layouts/{{ layout.id }}/designer" class="btn btn-primary">
                            Edit
                        </a>
                        <button class="btn btn-secondary" onclick="duplicateLayout('{{ layout.id }}', '{{ layout.name }}')">
                            Duplicate
                        </button>
                        <button class="btn btn-danger" onclick="deleteLayout('{{ layout.id }}', '{{ layout.name }}')">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state" style="background: rgba(255, 255, 255, 0.95); padding: 60px; border-radius: 20px;">
            <div class="empty-state-icon">Layout</div>
            <h3>No layouts created yet</h3>
            <p>Create your first layout using the form on the right to get started!</p>
        </div>
        {% endif %}
    </div>

    <div class="sidebar">
        <div class="create-box">
            <h3>Create New Layout</h3>
            <form id="createLayoutForm">
                <div class="form-group">
                    <label>Layout Name</label>
                    <input type="text" id="layoutName" placeholder="e.g., Main Store Display" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="layoutDescription" placeholder="What is this layout for?"></textarea>
                </div>
                <div class="form-group">
                    <label>Canvas Size (pixels)</label>
                    <div class="dimension-inputs">
                        <input type="number" id="canvasWidth" value="1920" min="20" max="10000" required>
                        <span>x</span>
                        <input type="number" id="canvasHeight" value="1080" min="20" max="10000" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Orientation</label>
                    <select id="orientation" onchange="updateDimensions()">
                        <option value="landscape">Landscape (Horizontal)</option>
                        <option value="portrait">Portrait (Vertical)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Background</label>
                    <select id="backgroundType">
                        <option value="solid">Solid Color</option>
                        <option value="transparent">Transparent</option>
                    </select>
                </div>
                <div class="form-group" id="backgroundColorGroup">
                    <label>Background Color</label>
                    <input type="color" id="backgroundColor" value="#000000" style="height: 40px; cursor: pointer;">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isTemplate" style="width: auto; margin-right: 8px;">
                        Save as Template
                    </label>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Create Layout</button>
                <div id="createStatus"></div>
            </form>
        </div>

        <div class="create-box">
            <h3>Quick Start Templates</h3>
            <div class="templates-grid">
                <div class="template-card" onclick="useTemplate('fullscreen')">
                    <div class="template-icon">Full</div>
                    <div class="template-name">Full Screen</div>
                </div>
                <div class="template-card" onclick="useTemplate('split')">
                    <div class="template-icon">Split</div>
                    <div class="template-name">70/30 Split</div>
                </div>
                <div class="template-card" onclick="useTemplate('lbar')">
                    <div class="template-icon">L</div>
                    <div class="template-name">L-Bar</div>
                </div>
                <div class="template-card" onclick="useTemplate('grid')">
                    <div class="template-icon">Grid</div>
                    <div class="template-name">2x2 Grid</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Toggle background color input based on background type
    document.getElementById('backgroundType').addEventListener('change', function() {
        const colorGroup = document.getElementById('backgroundColorGroup');
        colorGroup.style.display = this.value === 'solid' ? 'block' : 'none';
    });

    // Update dimensions when orientation changes
    function updateDimensions() {
        const orientation = document.getElementById('orientation').value;
        const widthInput = document.getElementById('canvasWidth');
        const heightInput = document.getElementById('canvasHeight');

        const currentWidth = parseInt(widthInput.value);
        const currentHeight = parseInt(heightInput.value);

        if (orientation === 'landscape' && currentHeight > currentWidth) {
            widthInput.value = currentHeight;
            heightInput.value = currentWidth;
        } else if (orientation === 'portrait' && currentWidth > currentHeight) {
            widthInput.value = currentHeight;
            heightInput.value = currentWidth;
        }
    }

    // Create layout form submission
    document.getElementById('createLayoutForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('layoutName').value;
        const description = document.getElementById('layoutDescription').value;
        const canvasWidth = parseInt(document.getElementById('canvasWidth').value);
        const canvasHeight = parseInt(document.getElementById('canvasHeight').value);
        const orientation = document.getElementById('orientation').value;
        const backgroundType = document.getElementById('backgroundType').value;
        const backgroundColor = document.getElementById('backgroundColor').value;
        const isTemplate = document.getElementById('isTemplate').checked;
        const statusDiv = document.getElementById('createStatus');

        try {
            const response = await fetch('/api/v1/layouts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name,
                    description,
                    canvas_width: canvasWidth,
                    canvas_height: canvasHeight,
                    orientation,
                    background_type: backgroundType,
                    background_color: backgroundColor,
                    is_template: isTemplate
                })
            });

            const data = await response.json();

            if (response.ok) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#d1fae5';
                statusDiv.style.color = '#065f46';
                statusDiv.textContent = 'Layout created! Redirecting to designer...';
                setTimeout(() => {
                    window.location.href = `/layouts/${data.id}/designer`;
                }, 1000);
            } else {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#fee2e2';
                statusDiv.style.color = '#991b1b';
                statusDiv.textContent = 'Failed to create layout: ' + (data.error || 'Unknown error');
            }
        } catch (error) {
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fee2e2';
            statusDiv.style.color = '#991b1b';
            statusDiv.textContent = 'Error: ' + error.message;
        }
    });

    // Use template
    function useTemplate(templateType) {
        const nameInput = document.getElementById('layoutName');
        const widthInput = document.getElementById('canvasWidth');
        const heightInput = document.getElementById('canvasHeight');
        const orientationInput = document.getElementById('orientation');

        // Remove selected class from all template cards
        document.querySelectorAll('.template-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Add selected class to clicked card
        event.currentTarget.classList.add('selected');

        // Set default values based on template
        switch (templateType) {
            case 'fullscreen':
                nameInput.value = nameInput.value || 'Full Screen Layout';
                widthInput.value = 1920;
                heightInput.value = 1080;
                orientationInput.value = 'landscape';
                break;
            case 'split':
                nameInput.value = nameInput.value || 'Split Screen Layout';
                widthInput.value = 1920;
                heightInput.value = 1080;
                orientationInput.value = 'landscape';
                break;
            case 'lbar':
                nameInput.value = nameInput.value || 'L-Bar Layout';
                widthInput.value = 1920;
                heightInput.value = 1080;
                orientationInput.value = 'landscape';
                break;
            case 'grid':
                nameInput.value = nameInput.value || '2x2 Grid Layout';
                widthInput.value = 1920;
                heightInput.value = 1080;
                orientationInput.value = 'landscape';
                break;
        }
    }

    // Duplicate layout
    async function duplicateLayout(layoutId, layoutName) {
        const newName = prompt('Enter name for the duplicate layout:', 'Copy of ' + layoutName);
        if (!newName) return;

        try {
            const response = await fetch(`/api/v1/layouts/${layoutId}/duplicate`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: newName,
                    include_layers: true
                })
            });

            const data = await response.json();

            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to duplicate layout: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    // Delete layout
    async function deleteLayout(layoutId, layoutName) {
        if (!confirm(`Are you sure you want to delete "${layoutName}"?\n\nThis will also delete all layers and content assignments.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/v1/layouts/${layoutId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                window.location.reload();
            } else {
                const data = await response.json();
                alert('Failed to delete layout: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
</script>
{% endblock %}
