{% extends "base.html" %}

{% block title %}Playlist Builder - Skillz Media Screens CMS{% endblock %}

{% block extra_styles %}
/* 3-Column Layout: Screens | Playlist Editor | Content Library */
.playlist-builder-layout {
    display: grid;
    grid-template-columns: 280px 1fr 320px;
    gap: 16px;
    height: calc(100vh - 100px);
    margin-top: 16px;
}

/* Common Panel Styles */
.panel {
    background: white;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.panel-header {
    padding: 16px;
    border-bottom: 1px solid #e5e7eb;
    background: #f9fafb;
}

.panel-header h3 {
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin: 0;
}

.panel-search {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    margin-bottom: 12px;
}

.panel-search input {
    border: none;
    outline: none;
    flex: 1;
    font-size: 13px;
}

.panel-search .search-icon {
    color: #9ca3af;
    font-size: 14px;
}

.panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
}

/* ========================================
   LEFT PANEL: Playlists by Network
   ======================================== */
.playlists-panel .panel-header {
    padding-bottom: 12px;
}

.network-group {
    margin-bottom: 16px;
}

.network-group-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f3f4f6;
    border-radius: 6px;
    margin-bottom: 4px;
    cursor: pointer;
    transition: background 0.15s;
}

.network-group-header:hover {
    background: #e5e7eb;
}

.network-group-header .network-icon {
    font-size: 14px;
}

.network-group-header .network-name {
    flex: 1;
    font-size: 13px;
    font-weight: 600;
    color: #374151;
}

.network-group-header .network-count {
    font-size: 11px;
    color: #9ca3af;
    background: white;
    padding: 2px 8px;
    border-radius: 10px;
}

.network-group-header .expand-icon {
    color: #9ca3af;
    font-size: 12px;
    transition: transform 0.2s;
}

.network-group.collapsed .expand-icon {
    transform: rotate(-90deg);
}

.network-group.collapsed .playlist-list {
    display: none;
}

.playlist-list {
    padding-left: 12px;
}

.playlist-item-link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s;
    margin-bottom: 2px;
}

.playlist-item-link:hover {
    background: #f3f4f6;
}

.playlist-item-link.active {
    background: #eef2ff;
    border-left: 3px solid #667eea;
}

.playlist-item-main {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
    min-width: 0;
    padding: 2px 4px;
}

.playlist-item-link .playlist-icon {
    font-size: 14px;
    color: #6b7280;
}

.playlist-item-link .playlist-name {
    flex: 1;
    font-size: 13px;
    color: #374151;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.playlist-item-link .playlist-items-count {
    font-size: 11px;
    color: #9ca3af;
}

/* Playlist Action Buttons */
.playlist-item-actions {
    display: none;
    gap: 2px;
}

.playlist-item-link:hover .playlist-item-actions {
    display: flex;
}

.playlist-action-mini {
    background: none;
    border: none;
    padding: 4px 6px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    opacity: 0.6;
    transition: all 0.15s;
}

.playlist-action-mini:hover {
    background: #e5e7eb;
    opacity: 1;
}

.playlist-action-mini.delete:hover {
    background: #fee2e2;
}

.no-playlists-msg {
    padding: 12px;
    text-align: center;
    color: #9ca3af;
    font-size: 12px;
    font-style: italic;
}

.create-playlist-btn {
    width: 100%;
    padding: 10px 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.2s;
}

.create-playlist-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.screen-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.screen-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s;
    margin-bottom: 2px;
}

.screen-item:hover {
    background: #f3f4f6;
}

.screen-item.active {
    background: #eef2ff;
}

.screen-checkbox {
    width: 16px;
    height: 16px;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    cursor: pointer;
}

.screen-checkbox:checked {
    background: #667eea;
    border-color: #667eea;
}

.screen-icon {
    font-size: 16px;
    color: #6b7280;
}

.screen-name {
    flex: 1;
    font-size: 13px;
    color: #374151;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.screen-count {
    font-size: 12px;
    color: #9ca3af;
    background: #f3f4f6;
    padding: 2px 8px;
    border-radius: 10px;
}

.screen-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.screen-status.online { background: #22c55e; }
.screen-status.offline { background: #ef4444; }
.screen-status.warning { background: #f59e0b; }
.screen-status.info { background: #3b82f6; }

/* ========================================
   CENTER PANEL: Playlist Editor
   ======================================== */
.playlist-editor-panel {
    display: flex;
    flex-direction: column;
}

.playlist-title-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    border-bottom: 1px solid #e5e7eb;
}

.playlist-title {
    font-size: 18px;
    font-weight: 600;
    color: #111827;
    display: flex;
    align-items: center;
    gap: 8px;
}

.playlist-title-input {
    font-size: 18px;
    font-weight: 600;
    color: #111827;
    border: none;
    background: transparent;
    outline: none;
    padding: 4px 8px;
    border-radius: 4px;
    min-width: 200px;
}

.playlist-title-input:focus {
    background: #f3f4f6;
}

.edit-title-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: #9ca3af;
    font-size: 14px;
}

.edit-title-btn:hover {
    color: #374151;
}

.playlist-actions {
    display: flex;
    gap: 8px;
    margin-left: auto;
}

.playlist-action-btn {
    padding: 8px;
    background: none;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    cursor: pointer;
    color: #6b7280;
    font-size: 16px;
    transition: all 0.15s;
}

.playlist-action-btn:hover {
    background: #f3f4f6;
    color: #374151;
}

.save-playlist-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    border: none !important;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.save-playlist-btn:hover {
    box-shadow: 0 4px 14px rgba(102, 126, 234, 0.5);
    transform: translateY(-1px);
}

.save-playlist-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

/* Stats Bar */
.playlist-stats {
    display: flex;
    gap: 24px;
    padding: 12px 20px;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    font-size: 13px;
    color: #6b7280;
}

.playlist-stat {
    display: flex;
    align-items: center;
    gap: 6px;
}

.playlist-stat strong {
    color: #111827;
    font-weight: 600;
}

.stat-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #667eea;
}

/* Selection Bar */
.selection-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 20px;
    border-bottom: 1px solid #e5e7eb;
    font-size: 13px;
    color: #6b7280;
}

.select-all-checkbox {
    width: 16px;
    height: 16px;
}

/* Playlist Items */
.playlist-items {
    flex: 1;
    overflow-y: auto;
    padding: 0;
}

.playlist-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 20px;
    border-bottom: 1px solid #f3f4f6;
    transition: background 0.15s;
}

.playlist-item:hover {
    background: #f9fafb;
}

.playlist-item.dragging {
    background: #eef2ff;
    opacity: 0.8;
}

.playlist-item.drag-over {
    border-top: 2px solid #667eea;
}

.item-number {
    font-size: 13px;
    color: #9ca3af;
    width: 24px;
    text-align: center;
}

.item-thumbnail {
    width: 80px;
    height: 45px;
    background: #f3f4f6;
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.item-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.item-thumbnail .no-thumb {
    font-size: 24px;
    color: #9ca3af;
}

.item-info {
    flex: 1;
    min-width: 0;
}

.item-name {
    font-size: 13px;
    font-weight: 500;
    color: #111827;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
}

.item-type {
    font-size: 11px;
    color: #9ca3af;
    display: flex;
    align-items: center;
    gap: 4px;
}

.item-duration {
    font-size: 13px;
    color: #374151;
    font-weight: 500;
    white-space: nowrap;
}

.item-duration .unit {
    color: #9ca3af;
    font-weight: 400;
    margin-left: 2px;
}

.item-status {
    color: #667eea;
    font-size: 14px;
}

.item-actions {
    display: flex;
    gap: 4px;
}

.item-action-btn {
    padding: 6px;
    background: none;
    border: none;
    cursor: pointer;
    color: #9ca3af;
    border-radius: 4px;
    transition: all 0.15s;
}

.item-action-btn:hover {
    background: #f3f4f6;
    color: #374151;
}

.item-action-btn.delete:hover {
    background: #fee2e2;
    color: #dc2626;
}

/* Empty Playlist */
.playlist-empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: #9ca3af;
    text-align: center;
}

.playlist-empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

.playlist-empty h4 {
    font-size: 16px;
    color: #374151;
    margin: 0 0 8px 0;
}

.playlist-empty p {
    font-size: 13px;
    margin: 0;
}

/* ========================================
   RIGHT PANEL: Content Library
   ======================================== */
.content-library-panel .panel-header {
    padding-bottom: 12px;
}

.new-content-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    background: none;
    border: 1px solid #667eea;
    color: #667eea;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
}

.new-content-btn:hover {
    background: #eef2ff;
}

/* Folder List */
.folder-list {
    margin-bottom: 16px;
}

.folder-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s;
    margin-bottom: 2px;
}

.folder-item:hover {
    background: #f3f4f6;
}

.folder-item.active {
    background: #eef2ff;
}

.folder-icon {
    font-size: 16px;
    color: #6b7280;
}

.folder-name {
    flex: 1;
    font-size: 13px;
    color: #374151;
}

/* Asset List */
.asset-list {
    border-top: 1px solid #e5e7eb;
    padding-top: 12px;
}

.asset-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    border-radius: 6px;
    cursor: grab;
    transition: all 0.15s;
    margin-bottom: 4px;
}

.asset-item:hover {
    background: #f3f4f6;
}

.asset-item.dragging {
    opacity: 0.5;
    background: #eef2ff;
}

.asset-item:active {
    cursor: grabbing;
}

.asset-thumb {
    width: 48px;
    height: 32px;
    background: #f3f4f6;
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.asset-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.asset-thumb .no-thumb {
    font-size: 16px;
    color: #9ca3af;
}

.asset-info {
    flex: 1;
    min-width: 0;
}

.asset-name {
    font-size: 12px;
    font-weight: 500;
    color: #374151;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.asset-meta {
    font-size: 10px;
    color: #9ca3af;
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 2px;
}

/* Drop Zone Indicator */
.drop-zone-active {
    border: 2px dashed #667eea !important;
    background: #eef2ff !important;
}

/* Toast */
.toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: white;
    padding: 14px 20px;
    border-radius: 8px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 10000;
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.3s ease;
}

.toast.show {
    transform: translateX(0);
    opacity: 1;
}

.toast.success { border-left: 4px solid #667eea; }
.toast.error { border-left: 4px solid #ef4444; }

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-header h3 {
    font-size: 18px;
    color: #111827;
    font-weight: 600;
    margin: 0;
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #9ca3af;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: #374151;
    margin-bottom: 6px;
}

.form-group input, .form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 14px;
}

.form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: #667eea;
}

.btn {
    padding: 10px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border: none;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

{% endblock %}

{% block content %}
<div class="playlist-builder-layout">
    <!-- LEFT: Playlists by Network Panel -->
    <div class="panel playlists-panel">
        <div class="panel-header">
            <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin: 0 0 12px 0;">Playlists</h3>
            <div class="panel-search">
                <span class="search-icon">üîç</span>
                <input type="text" placeholder="Search playlists" id="playlistSearch" oninput="filterPlaylists(this.value)">
            </div>
            <button class="create-playlist-btn" onclick="openNewPlaylistModal()">
                Create Playlist
            </button>
        </div>
        <div class="panel-content" id="playlistsPanel">
            <!-- Playlists by Network -->
            {% for network in networks %}
            <div class="network-group" data-network="{{ network.id }}">
                <div class="network-group-header" onclick="toggleNetworkGroup(this)">
                    <span class="network-icon">üåê</span>
                    <span class="network-name">{{ network.name }}</span>
                    <span class="network-count">{{ playlists|selectattr('network_id', 'equalto', network.id)|list|length }}</span>
                    <span class="expand-icon">‚ñº</span>
                </div>
                <div class="playlist-list">
                    {% for playlist in playlists if playlist.network_id == network.id %}
                    <div class="playlist-item-link {% if current_playlist and current_playlist.id == playlist.id %}active{% endif %}"
                         data-id="{{ playlist.id }}"
                         data-network="{{ playlist.network_id }}">
                        <div class="playlist-item-main" onclick="loadPlaylist('{{ playlist.id }}')">
                            <span class="playlist-icon">üìã</span>
                            <span class="playlist-name">{{ playlist.name }}</span>
                            <span class="playlist-items-count">{{ playlist.items.count() if playlist.items else 0 }}</span>
                        </div>
                        <div class="playlist-item-actions">
                            <button class="playlist-action-mini" onclick="event.stopPropagation(); archivePlaylist('{{ playlist.id }}', '{{ playlist.name }}')" title="Archive">üì•</button>
                            <button class="playlist-action-mini delete" onclick="event.stopPropagation(); deletePlaylist('{{ playlist.id }}', '{{ playlist.name }}')" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                    {% else %}
                    <div class="no-playlists-msg">No playlists in this network</div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

            <!-- Unassigned Playlists -->
            <div class="network-group" data-network="unassigned">
                <div class="network-group-header" onclick="toggleNetworkGroup(this)">
                    <span class="network-icon">üìÇ</span>
                    <span class="network-name">Unassigned</span>
                    <span class="network-count">{{ playlists|rejectattr('network_id')|list|length }}</span>
                    <span class="expand-icon">‚ñº</span>
                </div>
                <div class="playlist-list">
                    {% for playlist in playlists if not playlist.network_id %}
                    <div class="playlist-item-link {% if current_playlist and current_playlist.id == playlist.id %}active{% endif %}"
                         data-id="{{ playlist.id }}"
                         data-network="">
                        <div class="playlist-item-main" onclick="loadPlaylist('{{ playlist.id }}')">
                            <span class="playlist-icon">üìã</span>
                            <span class="playlist-name">{{ playlist.name }}</span>
                            <span class="playlist-items-count">{{ playlist.items.count() if playlist.items else 0 }}</span>
                        </div>
                        <div class="playlist-item-actions">
                            <button class="playlist-action-mini" onclick="event.stopPropagation(); archivePlaylist('{{ playlist.id }}', '{{ playlist.name }}')" title="Archive">üì•</button>
                            <button class="playlist-action-mini delete" onclick="event.stopPropagation(); deletePlaylist('{{ playlist.id }}', '{{ playlist.name }}')" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                    {% else %}
                    <div class="no-playlists-msg">No unassigned playlists</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- CENTER: Playlist Editor -->
    <div class="panel playlist-editor-panel">
        <div class="playlist-title-bar">
            <div class="playlist-title">
                <input type="text" class="playlist-title-input" id="playlistName" value="{{ current_playlist.name if current_playlist else 'New Playlist' }}" onchange="updatePlaylistName()">
                <button class="edit-title-btn">‚úèÔ∏è</button>
            </div>
            <div class="playlist-actions">
                <button class="btn btn-primary save-playlist-btn" id="savePlaylistBtn" onclick="savePlaylist()" title="Save playlist to server" style="padding: 8px 20px; font-size: 14px; font-weight: 600; border-radius: 6px; display: flex; align-items: center; gap: 6px;">
                    <span id="savePlaylistIcon">üíæ</span> Save Playlist
                </button>
                <button class="playlist-action-btn" title="Refresh" onclick="if(currentPlaylistId) loadPlaylist(currentPlaylistId)">üîÑ</button>
                <button class="playlist-action-btn" title="Delete" onclick="if(currentPlaylistId) deletePlaylist(currentPlaylistId, document.getElementById('playlistName').value)">üóëÔ∏è</button>
            </div>
        </div>

        <div class="playlist-stats">
            <div class="playlist-stat">
                Total size <strong id="totalSize">0 MB</strong>
            </div>
            <div class="playlist-stat">
                Total time <strong id="totalTime">0</strong> sec
            </div>
            <div class="playlist-stat">
                # of items <strong id="itemCount">0</strong>
            </div>
            <div class="playlist-stat">
                <span class="stat-indicator"></span>
            </div>
        </div>

        <div class="selection-bar">
            <input type="checkbox" class="select-all-checkbox" id="selectAll" onchange="toggleSelectAll()">
            <span>Selected (<span id="selectedCount">0</span>)</span>
        </div>

        <div class="playlist-items" id="playlistItems"
             ondragover="handlePlaylistDragOver(event)"
             ondragleave="handlePlaylistDragLeave(event)"
             ondrop="handlePlaylistDrop(event)">
            <!-- Playlist items will be rendered here -->
            <div class="playlist-empty" id="playlistEmpty">
                <div class="playlist-empty-icon">üìã</div>
                <h4>No items in playlist</h4>
                <p>Drag content from the right panel to add items</p>
            </div>
        </div>
    </div>

    <!-- RIGHT: Content Library -->
    <div class="panel content-library-panel">
        <div class="panel-header">
            <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin: 0 0 12px 0;">Content</h3>
            <div class="panel-search">
                <span class="search-icon">üîç</span>
                <input type="text" placeholder="Search content" id="contentSearch" oninput="filterContent(this.value)">
            </div>
        </div>
        <div class="panel-content">
            <!-- Networks as Folders -->
            <div class="folder-list" id="networkList">
                {% for network in networks %}
                <div class="folder-item" data-network="{{ network.slug }}" data-network-id="{{ network.id }}" data-network-name="{{ network.name }}" onclick="selectContentNetwork('{{ network.slug }}', '{{ network.id }}', '{{ network.name }}')">
                    <span class="folder-icon">üìÅ</span>
                    <span class="folder-name">{{ network.name }}</span>
                </div>
                {% endfor %}
            </div>

            <!-- Folders Section (shown when a network is selected) -->
            <div id="contentFoldersSection" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                <!-- Navigation Bar -->
                <div id="contentNavBar" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f8fafc; border-radius: 6px;">
                    <button id="contentBackButton" onclick="goBackContent()" style="display: none; padding: 4px 8px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 12px; color: #374151;">
                        ‚Üê
                    </button>
                    <div id="contentBreadcrumb" style="flex: 1; font-size: 12px; color: #64748b; display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">
                        <span style="color: #667eea; cursor: pointer;" onclick="goToContentNetworkRoot()">Network</span>
                    </div>
                </div>
                <!-- Folders Grid -->
                <div id="contentFoldersGrid" style="margin-bottom: 8px;"></div>
            </div>

            <!-- Approved Assets -->
            <div class="asset-list" id="assetList" style="border-top: 1px solid #e5e7eb; padding-top: 8px; margin-top: 8px;">
                {% for item in content if item.status == 'approved' %}
                <div class="asset-item"
                     data-id="{{ item.id }}"
                     data-title="{{ item.original_name }}"
                     data-duration="{{ item.duration or 10 }}"
                     data-size="{{ item.file_size or 0 }}"
                     data-filename="{{ item.filename }}"
                     data-type="{% if item.is_video %}video{% elif item.is_image %}image{% else %}other{% endif %}"
                     data-networks='{{ item.network_ids|tojson|safe }}'
                     data-folder="{{ item.folder_id or '' }}"
                     data-source="{{ item.source or 'local' }}"
                     draggable="true"
                     onclick="previewContent(this)"
                     ondragstart="handleAssetDragStart(event)"
                     ondragend="handleAssetDragEnd(event)">
                    <div class="asset-thumb">
                        <span class="no-thumb">{% if item.is_video %}üé¨{% elif item.is_image %}üñºÔ∏è{% else %}üìÑ{% endif %}</span>
                    </div>
                    <div class="asset-info">
                        <div class="asset-name">{{ item.original_name }}</div>
                        <div class="asset-meta">
                            <span>{% if item.is_video %}üé¨{% elif item.is_image %}üñºÔ∏è{% else %}üìÑ{% endif %}</span>
                            {{ item.duration or 10 }}s
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- New Playlist Modal -->
<div class="modal" id="newPlaylistModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Playlist</h3>
            <button class="close-btn" onclick="closeNewPlaylistModal()">&times;</button>
        </div>
        <form onsubmit="createPlaylist(event)">
            <div class="form-group">
                <label>Playlist Name</label>
                <input type="text" id="newPlaylistName" placeholder="Enter playlist name" required>
            </div>
            <div class="form-group">
                <label>Network</label>
                <select id="newPlaylistNetwork" required>
                    <option value="">Select a network...</option>
                    {% for network in networks %}
                    <option value="{{ network.id }}">{{ network.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Loop Mode</label>
                <select id="newPlaylistLoop">
                    <option value="continuous">Continuous (Loop forever)</option>
                    <option value="play_once">Play Once</option>
                    <option value="scheduled">Scheduled (Date range)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select id="newPlaylistPriority">
                    <option value="normal">Normal</option>
                    <option value="high">High (Plays before normal)</option>
                    <option value="interrupt">Interrupt (For alerts)</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Create Playlist</button>
        </form>
    </div>
</div>

<!-- Item Settings Modal -->
<div class="modal" id="itemTriggerModal">
    <div class="modal-content" style="max-width: 480px;">
        <div class="modal-header">
            <h3>Edit Item</h3>
            <button class="close-btn" onclick="closeItemTriggerModal()">&times;</button>
        </div>
        <form onsubmit="saveItemSettings(event)">
            <input type="hidden" id="itemSettingsIndex">

            <!-- Content Preview -->
            <div style="background: #1a1a2e; border-radius: 8px; overflow: hidden; margin-bottom: 16px;">
                <div id="itemPreview" style="width: 100%; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; background: #0a0a10;">
                    <span style="font-size: 48px; color: #4a4a6a;">üé¨</span>
                </div>
            </div>

            <!-- Title -->
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="itemTitle" readonly style="background: #f9fafb; cursor: default;">
            </div>

            <!-- Duration Control -->
            <div class="form-group">
                <label>Duration (seconds)</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button type="button" onclick="adjustDuration(-5)" style="width: 40px; height: 40px; border: 1px solid #e5e7eb; background: white; border-radius: 8px; font-size: 18px; cursor: pointer;">‚àí</button>
                    <input type="number" id="itemDuration" min="1" max="300" style="flex: 1; text-align: center; font-size: 18px; font-weight: 600;">
                    <button type="button" onclick="adjustDuration(5)" style="width: 40px; height: 40px; border: 1px solid #e5e7eb; background: white; border-radius: 8px; font-size: 18px; cursor: pointer;">+</button>
                </div>
                <small style="color: #6b7280; font-size: 11px; margin-top: 6px; display: block;">
                    For images, set how long to display. Videos play their full length by default.
                </small>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button type="button" class="btn" style="flex: 1; background: #f3f4f6; color: #374151;" onclick="closeItemTriggerModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Content Preview Modal -->
<div class="modal" id="contentPreviewModal">
    <div class="modal-content" style="max-width: 720px; padding: 0; overflow: hidden;">
        <div class="modal-header" style="padding: 16px 20px; margin: 0; border-bottom: 1px solid #e5e7eb;">
            <h3 id="previewTitle" style="margin: 0;">Content Preview</h3>
            <button class="close-btn" onclick="closeContentPreview()">&times;</button>
        </div>
        <div style="background: #0a0a10; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; position: relative;">
            <div id="previewContainer" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                <span style="font-size: 48px; color: #4a4a6a;">üé¨</span>
            </div>
        </div>

        <!-- Trim Controls (for video) -->
        <div id="trimControls" style="padding: 16px 20px; background: #1a1a2e; display: none;">
            <div style="margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 12px; color: #9ca3af;">Trim Video</span>
                    <span id="trimDuration" style="font-size: 12px; color: #667eea; font-weight: 600;">0s selected</span>
                </div>
                <!-- Timeline slider -->
                <div id="trimSliderContainer" style="position: relative; height: 48px; background: #2d2d44; border-radius: 6px; overflow: visible;">
                    <!-- Background track -->
                    <div style="position: absolute; top: 16px; left: 12px; right: 12px; height: 16px; background: #3d3d54; border-radius: 4px;"></div>
                    <!-- Selected range highlight -->
                    <div id="trimRangeHighlight" style="position: absolute; top: 16px; height: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px; left: 12px; right: 12px;"></div>
                    <!-- Start handle -->
                    <div id="trimStartHandle"
                         style="position: absolute; top: 8px; left: 0; width: 24px; height: 32px; background: #667eea; border-radius: 4px; cursor: ew-resize; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 10;"
                         onmousedown="startDragHandle('start', event)"
                         ontouchstart="startDragHandle('start', event)">
                        <div style="width: 2px; height: 16px; background: rgba(255,255,255,0.5); border-radius: 1px;"></div>
                    </div>
                    <!-- End handle -->
                    <div id="trimEndHandle"
                         style="position: absolute; top: 8px; right: 0; width: 24px; height: 32px; background: #667eea; border-radius: 4px; cursor: ew-resize; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 10;"
                         onmousedown="startDragHandle('end', event)"
                         ontouchstart="startDragHandle('end', event)">
                        <div style="width: 2px; height: 16px; background: rgba(255,255,255,0.5); border-radius: 1px;"></div>
                    </div>
                </div>
                <!-- Time markers -->
                <div style="display: flex; justify-content: space-between; margin: 4px 12px 0; font-size: 10px; color: #6b7280;">
                    <span>0:00</span>
                    <span id="trimTotalTime">0:00</span>
                </div>
            </div>
            <div style="display: flex; gap: 12px;">
                <div style="flex: 1;">
                    <label style="font-size: 11px; color: #9ca3af; display: block; margin-bottom: 4px;">Start Time</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="text" id="trimStartTime" value="00:00"
                               style="flex: 1; padding: 8px 12px; background: #2d2d44; border: 1px solid #3d3d54; border-radius: 6px; color: white; font-family: monospace; font-size: 14px;"
                               onchange="updateTrimFromInput()">
                        <button type="button" onclick="setTrimStartFromVideo()"
                                style="padding: 8px 12px; background: #667eea; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;"
                                title="Set to current video position">Set</button>
                    </div>
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 11px; color: #9ca3af; display: block; margin-bottom: 4px;">End Time</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="text" id="trimEndTime" value="00:00"
                               style="flex: 1; padding: 8px 12px; background: #2d2d44; border: 1px solid #3d3d54; border-radius: 6px; color: white; font-family: monospace; font-size: 14px;"
                               onchange="updateTrimFromInput()">
                        <button type="button" onclick="setTrimEndFromVideo()"
                                style="padding: 8px 12px; background: #667eea; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;"
                                title="Set to current video position">Set</button>
                    </div>
                </div>
            </div>
            <div style="margin-top: 12px; display: flex; gap: 8px;">
                <button type="button" onclick="previewTrimmedSection()"
                        style="flex: 1; padding: 8px 12px; background: transparent; border: 1px solid #667eea; border-radius: 6px; color: #667eea; font-size: 13px; cursor: pointer;">
                    Preview Selection
                </button>
                <button type="button" onclick="resetTrim()"
                        style="padding: 8px 12px; background: transparent; border: 1px solid #4a4a6a; border-radius: 6px; color: #9ca3af; font-size: 13px; cursor: pointer;">
                    Reset
                </button>
            </div>
        </div>

        <!-- Duration Controls (for non-video content) -->
        <div id="durationControls" style="padding: 16px 20px; background: #1a1a2e; display: none;">
            <label style="font-size: 12px; color: #9ca3af; display: block; margin-bottom: 8px;">Display Duration</label>
            <div style="display: flex; align-items: center; gap: 12px;">
                <button type="button" onclick="adjustContentDuration(-5)"
                        style="width: 40px; height: 40px; background: #2d2d44; border: 1px solid #3d3d54; border-radius: 8px; color: white; font-size: 18px; cursor: pointer;">‚àí</button>
                <input type="number" id="contentDuration" min="1" max="300" value="10"
                       style="flex: 1; padding: 10px; background: #2d2d44; border: 1px solid #3d3d54; border-radius: 6px; color: white; font-size: 18px; font-weight: 600; text-align: center;">
                <button type="button" onclick="adjustContentDuration(5)"
                        style="width: 40px; height: 40px; background: #2d2d44; border: 1px solid #3d3d54; border-radius: 8px; color: white; font-size: 18px; cursor: pointer;">+</button>
                <span style="color: #9ca3af; font-size: 14px;">seconds</span>
            </div>
        </div>

        <div style="padding: 16px 20px; background: #f9fafb; border-top: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div>
                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 4px;">Original Duration</div>
                    <div id="previewDuration" style="font-size: 14px; font-weight: 600; color: #111827;">--</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 4px;">Type</div>
                    <div id="previewType" style="font-size: 14px; font-weight: 600; color: #111827;">--</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 4px;">Size</div>
                    <div id="previewSize" style="font-size: 14px; font-weight: 600; color: #111827;">--</div>
                </div>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="addPreviewedContentToPlaylist()">
                Add to Playlist
            </button>
        </div>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal" id="createFolderModal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>Create New Folder</h3>
            <button class="close-btn" onclick="closeCreateFolderModal()">&times;</button>
        </div>
        <form onsubmit="createFolder(event)">
            <div class="form-group">
                <label>Folder Name</label>
                <input type="text" id="newFolderName" placeholder="Enter folder name" required>
                <small style="color: #6b7280; font-size: 11px; margin-top: 4px; display: block;">
                    Examples: Summer Campaign, Store Promos, Q1 2026, Holiday Specials
                </small>
            </div>
            <div class="form-group">
                <label>Icon</label>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button type="button" class="icon-btn active" data-icon="üìÅ" onclick="selectFolderIcon(this)">üìÅ</button>
                    <button type="button" class="icon-btn" data-icon="üìÇ" onclick="selectFolderIcon(this)">üìÇ</button>
                    <button type="button" class="icon-btn" data-icon="üé¨" onclick="selectFolderIcon(this)">üé¨</button>
                    <button type="button" class="icon-btn" data-icon="üñºÔ∏è" onclick="selectFolderIcon(this)">üñºÔ∏è</button>
                    <button type="button" class="icon-btn" data-icon="üéµ" onclick="selectFolderIcon(this)">üéµ</button>
                    <button type="button" class="icon-btn" data-icon="üìä" onclick="selectFolderIcon(this)">üìä</button>
                    <button type="button" class="icon-btn" data-icon="üè∑Ô∏è" onclick="selectFolderIcon(this)">üè∑Ô∏è</button>
                    <button type="button" class="icon-btn" data-icon="‚≠ê" onclick="selectFolderIcon(this)">‚≠ê</button>
                    <button type="button" class="icon-btn" data-icon="üè™" onclick="selectFolderIcon(this)">üè™</button>
                    <button type="button" class="icon-btn" data-icon="üìÖ" onclick="selectFolderIcon(this)">üìÖ</button>
                    <button type="button" class="icon-btn" data-icon="üéØ" onclick="selectFolderIcon(this)">üéØ</button>
                    <button type="button" class="icon-btn" data-icon="üí∞" onclick="selectFolderIcon(this)">üí∞</button>
                </div>
                <input type="hidden" id="newFolderIcon" value="üìÅ">
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Create Folder</button>
        </form>
    </div>
</div>

<style>
.icon-btn {
    width: 40px;
    height: 40px;
    border: 2px solid #e5e7eb;
    background: white;
    border-radius: 8px;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.15s;
}
.icon-btn:hover {
    border-color: #667eea;
    background: #eef2ff;
}
.icon-btn.active {
    border-color: #667eea;
    background: #eef2ff;
}
.subfolder-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f9fafb;
    border-radius: 6px;
    margin-bottom: 4px;
    cursor: pointer;
    transition: background 0.15s;
}
.subfolder-item:hover {
    background: #eef2ff;
}
.subfolder-item .folder-icon {
    font-size: 16px;
}
.subfolder-item .folder-name {
    flex: 1;
    font-size: 13px;
    color: #374151;
}
.breadcrumb-item {
    color: #667eea;
    cursor: pointer;
}
.breadcrumb-item:hover {
    text-decoration: underline;
}
.breadcrumb-separator {
    color: #9ca3af;
    margin: 0 2px;
}
</style>

{% endblock %}

{% block extra_scripts %}
<script>
// Playlist state
let playlistItems = [];
let currentPlaylistId = null;
let selectedItems = new Set();
let draggedAsset = null;

// Folder navigation state
let currentNetworkId = null;
let currentFolderId = null;
let folderPath = []; // Array of {id, name} for breadcrumb

// ==========================================================================
// Initialize
// ==========================================================================
document.addEventListener('DOMContentLoaded', function() {
    // Load existing playlist if any
    {% if current_playlist %}
    currentPlaylistId = '{{ current_playlist.id }}';
    playlistItems = {{ current_playlist.items|tojson|safe if current_playlist.items else '[]' }};
    renderPlaylistItems();
    {% endif %}
    updateStats();

    // Select the first network by default in content panel
    const firstNetwork = document.querySelector('#networkList .folder-item[data-network]');
    if (firstNetwork) {
        const slug = firstNetwork.dataset.network;
        const networkId = firstNetwork.dataset.networkId;
        const name = firstNetwork.dataset.networkName;
        selectContentNetwork(slug, networkId, name);
    }
});

// ==========================================================================
// Playlist Panel Functions
// ==========================================================================
function toggleNetworkGroup(header) {
    const group = header.closest('.network-group');
    group.classList.toggle('collapsed');
}

function filterPlaylists(query) {
    const items = document.querySelectorAll('.playlist-item-link');
    const q = query.toLowerCase();
    items.forEach(item => {
        const name = item.querySelector('.playlist-name').textContent.toLowerCase();
        item.style.display = name.includes(q) ? 'flex' : 'none';
    });

    // Show all network groups when filtering
    if (q) {
        document.querySelectorAll('.network-group').forEach(g => g.classList.remove('collapsed'));
    }
}

async function loadPlaylist(playlistId) {
    try {
        const response = await fetch(`/api/v1/playlists/${playlistId}`);
        if (response.ok) {
            const playlist = await response.json();
            currentPlaylistId = playlist.id;
            document.getElementById('playlistName').value = playlist.name;

            // Load playlist items
            playlistItems = (playlist.items || []).map(item => ({
                id: item.id || Date.now().toString(),
                contentId: item.content_id,
                syncedContentId: item.synced_content_id || null,
                title: item.content?.title || item.title || 'Unknown',
                duration: item.duration || item.content?.duration || 0,
                size: item.content?.file_size || 0,
                filename: item.content?.local_filename || item.content?.filename || '',
                type: item.content?.content_type || 'video',
                thumbnail: item.content?.thumbnail_url || null
            }));

            renderPlaylistItems();
            updateStats();

            // Update active state in sidebar
            document.querySelectorAll('.playlist-item-link').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.id === playlistId) {
                    el.classList.add('active');
                }
            });

            showToast(true, 'Loaded', `Playlist "${playlist.name}" loaded`);
        } else {
            showToast(false, 'Error', 'Failed to load playlist');
        }
    } catch (error) {
        showToast(false, 'Error', error.message);
    }
}

function addPlaylistToSidebar(playlist) {
    const networkId = playlist.network_id || '';

    // Create playlist item element
    const newItem = document.createElement('div');
    newItem.className = 'playlist-item-link active';
    newItem.dataset.id = playlist.id;
    newItem.dataset.network = networkId;
    newItem.onclick = () => loadPlaylist(playlist.id);
    newItem.innerHTML = `
        <span class="playlist-icon">üìã</span>
        <span class="playlist-name">${escapeHtml(playlist.name)}</span>
        <span class="playlist-items-count">0</span>
    `;

    // Remove active from other items
    document.querySelectorAll('.playlist-item-link').forEach(el => el.classList.remove('active'));

    // Add to network-specific section or unassigned
    if (networkId) {
        const networkGroup = document.querySelector(`.network-group[data-network="${networkId}"] .playlist-list`);
        if (networkGroup) {
            const networkNoMsg = networkGroup.querySelector('.no-playlists-msg');
            if (networkNoMsg) networkNoMsg.remove();

            networkGroup.insertBefore(newItem, networkGroup.firstChild);

            // Update network count
            const networkCount = networkGroup.closest('.network-group').querySelector('.network-count');
            if (networkCount) {
                networkCount.textContent = parseInt(networkCount.textContent) + 1;
            }
        }
    } else {
        // Add to unassigned section
        const unassignedGroup = document.querySelector('.network-group[data-network="unassigned"] .playlist-list');
        if (unassignedGroup) {
            const unassignedNoMsg = unassignedGroup.querySelector('.no-playlists-msg');
            if (unassignedNoMsg) unassignedNoMsg.remove();

            unassignedGroup.insertBefore(newItem, unassignedGroup.firstChild);

            // Update unassigned count
            const unassignedCount = unassignedGroup.closest('.network-group').querySelector('.network-count');
            if (unassignedCount) {
                unassignedCount.textContent = parseInt(unassignedCount.textContent) + 1;
            }
        }
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ==========================================================================
// Content Library
// ==========================================================================
// Content Library - Filter and Navigation
// ==========================================================================
let contentNetworkFolders = {}; // Store folders by network
let contentSearchQuery = '';
let currentNetworkSlug = null; // For filtering content (uses slug)

function filterContent(query) {
    contentSearchQuery = query.toLowerCase();
    filterContentAssets();
}

function selectContentNetwork(networkSlug, networkId, networkName) {
    currentNetworkSlug = networkSlug;  // For content filtering
    currentNetworkId = networkId;       // For folder API calls
    currentFolderId = null;
    folderPath = [];

    // Update active network folder
    document.querySelectorAll('#networkList .folder-item').forEach(f => f.classList.remove('active'));
    const selected = document.querySelector(`#networkList .folder-item[data-network="${networkSlug || ''}"]`);
    if (selected) selected.classList.add('active');

    // Show/hide folders section
    const foldersSection = document.getElementById('contentFoldersSection');
    if (networkId) {
        foldersSection.style.display = 'block';
        loadContentNetworkFolders(networkId, networkName);
    } else {
        foldersSection.style.display = 'none';
    }

    updateContentBackButton();
    filterContentAssets();
}

function loadContentNetworkFolders(networkId, networkName) {
    // Fetch folders for this network from API
    fetch(`/folders?network_id=${networkId}`)
        .then(response => response.json())
        .then(folders => {
            contentNetworkFolders[networkId] = folders;
            renderContentFolders(folders.filter(f => !f.parent_id));
            updateContentBreadcrumb(networkName);
        })
        .catch(error => {
            console.error('Error loading folders:', error);
            renderContentFolders([]);
        });
}

function renderContentFolders(folders) {
    const grid = document.getElementById('contentFoldersGrid');

    if (folders.length === 0) {
        grid.innerHTML = '<div style="font-size: 11px; color: #9ca3af; padding: 8px; font-style: italic;">No folders</div>';
        return;
    }

    grid.innerHTML = folders.map(folder => `
        <div class="subfolder-item" onclick="selectContentFolder('${folder.id}', '${escapeHtml(folder.name)}')" style="display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: #f9fafb; border-radius: 6px; margin-bottom: 4px; cursor: pointer; transition: background 0.15s;">
            <span style="font-size: 14px; color: ${folder.color || '#6b7280'};">${folder.icon || 'üìÅ'}</span>
            <span style="flex: 1; font-size: 12px; color: #374151;">${escapeHtml(folder.name)}</span>
            <span style="color: #9ca3af; font-size: 10px;">‚Ä∫</span>
        </div>
    `).join('');
}

function selectContentFolder(folderId, folderName) {
    currentFolderId = folderId;
    folderPath.push({ id: folderId, name: folderName });

    updateContentBreadcrumb();
    updateContentBackButton();

    // Load subfolders
    const subfolders = (contentNetworkFolders[currentNetworkId] || []).filter(f => f.parent_id === folderId);
    renderContentFolders(subfolders);

    filterContentAssets();
}

function goToContentNetworkRoot() {
    currentFolderId = null;
    folderPath = [];

    updateContentBreadcrumb();
    updateContentBackButton();

    // Load root folders
    const rootFolders = (contentNetworkFolders[currentNetworkId] || []).filter(f => !f.parent_id);
    renderContentFolders(rootFolders);

    filterContentAssets();
}

function goBackContent() {
    if (folderPath.length === 0) {
        return;
    } else if (folderPath.length === 1) {
        goToContentNetworkRoot();
    } else {
        folderPath.pop();
        const parentFolder = folderPath[folderPath.length - 1];
        currentFolderId = parentFolder.id;

        updateContentBreadcrumb();
        updateContentBackButton();

        // Load subfolders of parent
        const subfolders = (contentNetworkFolders[currentNetworkId] || []).filter(f => f.parent_id === parentFolder.id);
        renderContentFolders(subfolders);

        filterContentAssets();
    }
}

function goToContentFolder(folderId, index) {
    folderPath = folderPath.slice(0, index + 1);
    currentFolderId = folderId;

    updateContentBreadcrumb();
    updateContentBackButton();

    // Load subfolders
    const subfolders = (contentNetworkFolders[currentNetworkId] || []).filter(f => f.parent_id === folderId);
    renderContentFolders(subfolders);

    filterContentAssets();
}

function updateContentBreadcrumb(networkName) {
    const breadcrumb = document.getElementById('contentBreadcrumb');
    if (!networkName) {
        const networkEl = document.querySelector(`#networkList .folder-item[data-network="${currentNetworkSlug}"]`);
        networkName = networkEl ? networkEl.dataset.networkName : 'Network';
    }

    let html = `<span style="color: #667eea; cursor: pointer;" onclick="goToContentNetworkRoot()">${escapeHtml(networkName)}</span>`;

    folderPath.forEach((folder, index) => {
        html += ` <span style="color: #94a3b8;">/</span> `;
        if (index === folderPath.length - 1) {
            html += `<span style="color: #1e293b; font-weight: 500;">${escapeHtml(folder.name)}</span>`;
        } else {
            html += `<span style="color: #667eea; cursor: pointer;" onclick="goToContentFolder('${folder.id}', ${index})">${escapeHtml(folder.name)}</span>`;
        }
    });

    breadcrumb.innerHTML = html;
}

function updateContentBackButton() {
    const backBtn = document.getElementById('contentBackButton');
    if (backBtn) {
        backBtn.style.display = folderPath.length > 0 ? 'block' : 'none';
    }
}

function filterContentAssets() {
    const items = document.querySelectorAll('.asset-item');
    items.forEach(item => {
        let show = true;

        // Network filter - use slug for matching (like content.html does)
        if (currentNetworkSlug) {
            const networks = JSON.parse(item.dataset.networks || '[]');
            show = networks.includes(currentNetworkSlug);
        }

        // Folder filter
        if (show) {
            if (currentFolderId) {
                // Inside a folder - only show content in that folder
                show = item.dataset.folder === currentFolderId;
            } else if (currentNetworkSlug) {
                // At network root - only show content NOT in any folder
                show = !item.dataset.folder || item.dataset.folder === '';
            }
        }

        // Search filter
        if (contentSearchQuery && show) {
            const title = (item.dataset.title || '').toLowerCase();
            show = title.includes(contentSearchQuery);
        }

        item.style.display = show ? 'flex' : 'none';
    });
}

// ==========================================================================
// Folder Creation
// ==========================================================================
function openCreateFolderModal() {
    document.getElementById('newFolderName').value = '';
    document.getElementById('newFolderIcon').value = 'üìÅ';
    document.querySelectorAll('.icon-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.icon-btn[data-icon="üìÅ"]').classList.add('active');
    document.getElementById('createFolderModal').classList.add('active');
}

function closeCreateFolderModal() {
    document.getElementById('createFolderModal').classList.remove('active');
}

function selectFolderIcon(btn) {
    document.querySelectorAll('.icon-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('newFolderIcon').value = btn.dataset.icon;
}

async function createFolder(event) {
    event.preventDefault();

    const name = document.getElementById('newFolderName').value.trim();
    const icon = document.getElementById('newFolderIcon').value;

    if (!name) {
        showToast(false, 'Error', 'Please enter a folder name');
        return;
    }

    if (!currentNetworkId) {
        showToast(false, 'Error', 'Please select a network first');
        return;
    }

    try {
        const response = await fetch('/folders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                icon: icon,
                network_id: currentNetworkId,
                parent_id: currentFolderId // Will be null for root-level folders in current network
            })
        });

        if (response.ok) {
            const folder = await response.json();
            closeCreateFolderModal();
            showToast(true, 'Created', `Folder "${name}" created`);

            // Reload folders for this network
            loadContentNetworkFolders(currentNetworkId);
        } else {
            const err = await response.json();
            showToast(false, 'Error', err.error || 'Failed to create folder');
        }
    } catch (error) {
        showToast(false, 'Error', error.message);
    }
}

// ==========================================================================
// Drag & Drop
// ==========================================================================
function handleAssetDragStart(event) {
    draggedAsset = {
        id: event.target.dataset.id,
        title: event.target.dataset.title,
        duration: parseFloat(event.target.dataset.duration) || 0,
        size: parseInt(event.target.dataset.size) || 0,
        filename: event.target.dataset.filename,
        source: event.target.dataset.source || 'local',
        type: event.target.dataset.type,
        thumbnail: event.target.querySelector('img')?.src || null
    };
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'copy';
}

function handleAssetDragEnd(event) {
    event.target.classList.remove('dragging');
    draggedAsset = null;
}

function handlePlaylistDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'copy';
    document.getElementById('playlistItems').classList.add('drop-zone-active');
}

function handlePlaylistDragLeave(event) {
    document.getElementById('playlistItems').classList.remove('drop-zone-active');
}

function handlePlaylistDrop(event) {
    event.preventDefault();
    document.getElementById('playlistItems').classList.remove('drop-zone-active');

    if (draggedAsset) {
        // Add to playlist
        playlistItems.push({
            id: Date.now().toString(),
            contentId: draggedAsset.id,
            syncedContentId: draggedAsset.source === 'synced' ? draggedAsset.id : null,
            source: draggedAsset.source,
            title: draggedAsset.title,
            duration: draggedAsset.duration,
            size: draggedAsset.size,
            filename: draggedAsset.filename,
            type: draggedAsset.type,
            thumbnail: draggedAsset.thumbnail
        });

        renderPlaylistItems();
        updateStats();
        showToast(true, 'Added', `"${draggedAsset.title}" added to playlist`);
    }
}

// ==========================================================================
// Playlist Rendering
// ==========================================================================
function renderPlaylistItems() {
    const container = document.getElementById('playlistItems');
    const empty = document.getElementById('playlistEmpty');

    if (playlistItems.length === 0) {
        empty.style.display = 'flex';
        return;
    }

    empty.style.display = 'none';

    let html = '';
    playlistItems.forEach((item, index) => {
        const isSelected = selectedItems.has(item.id);
        html += `
            <div class="playlist-item" data-id="${item.id}" data-index="${index}"
                 draggable="true"
                 ondragstart="handleItemDragStart(event, ${index})"
                 ondragover="handleItemDragOver(event, ${index})"
                 ondrop="handleItemDrop(event, ${index})">
                <span class="item-number">${index + 1}</span>
                <div class="item-thumbnail">
                    ${item.thumbnail ? `<img src="${item.thumbnail}" alt="">` : `<span class="no-thumb">${item.type === 'video' ? 'üé¨' : 'üñºÔ∏è'}</span>`}
                </div>
                <div class="item-info">
                    <div class="item-name">${item.title}</div>
                    <div class="item-type">üìÑ</div>
                </div>
                <div class="item-duration">${item.duration.toFixed(2)}<span class="unit">sec</span></div>
                <span class="item-status">‚úì</span>
                <div class="item-actions">
                    <button class="item-action-btn" onclick="openItemSettings(${index})" title="Settings">‚öôÔ∏è</button>
                    <button class="item-action-btn" onclick="downloadItem('${item.contentId}')" title="Download">‚¨áÔ∏è</button>
                    <button class="item-action-btn delete" onclick="removeItem(${index})" title="Remove">üóëÔ∏è</button>
                </div>
            </div>
        `;
    });

    // Keep the empty state element but hidden
    container.innerHTML = html + '<div class="playlist-empty" id="playlistEmpty" style="display: none;"><div class="playlist-empty-icon">üìã</div><h4>No items in playlist</h4><p>Drag content from the right panel to add items</p></div>';
}

// Item reordering
let draggedItemIndex = null;

function handleItemDragStart(event, index) {
    draggedItemIndex = index;
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
}

function handleItemDragOver(event, index) {
    event.preventDefault();
    if (draggedItemIndex !== null && draggedItemIndex !== index) {
        event.target.closest('.playlist-item')?.classList.add('drag-over');
    }
}

function handleItemDrop(event, targetIndex) {
    event.preventDefault();
    document.querySelectorAll('.playlist-item').forEach(el => el.classList.remove('drag-over', 'dragging'));

    if (draggedItemIndex !== null && draggedItemIndex !== targetIndex) {
        // Reorder
        const item = playlistItems.splice(draggedItemIndex, 1)[0];
        playlistItems.splice(targetIndex, 0, item);
        renderPlaylistItems();
        updateStats();
    }
    draggedItemIndex = null;
}

function removeItem(index) {
    const item = playlistItems[index];
    playlistItems.splice(index, 1);
    renderPlaylistItems();
    updateStats();
    showToast(true, 'Removed', `"${item.title}" removed from playlist`);
}

// ==========================================================================
// Stats
// ==========================================================================
function updateStats() {
    const totalSize = playlistItems.reduce((sum, item) => sum + (item.size || 0), 0);
    const totalTime = playlistItems.reduce((sum, item) => sum + (item.duration || 0), 0);

    document.getElementById('totalSize').textContent = (totalSize / 1024 / 1024).toFixed(2) + ' MB';
    document.getElementById('totalTime').textContent = totalTime.toFixed(1);
    document.getElementById('itemCount').textContent = playlistItems.length;
}

// ==========================================================================
// Selection
// ==========================================================================
function toggleSelectAll() {
    const checkbox = document.getElementById('selectAll');
    if (checkbox.checked) {
        playlistItems.forEach(item => selectedItems.add(item.id));
    } else {
        selectedItems.clear();
    }
    document.getElementById('selectedCount').textContent = selectedItems.size;
}

// ==========================================================================
// Playlist Management
// ==========================================================================
function openNewPlaylistModal() {
    document.getElementById('newPlaylistModal').classList.add('active');
}

function closeNewPlaylistModal() {
    document.getElementById('newPlaylistModal').classList.remove('active');
}

async function createPlaylist(event) {
    event.preventDefault();
    const name = document.getElementById('newPlaylistName').value;
    const networkId = document.getElementById('newPlaylistNetwork').value || null;
    const loopMode = document.getElementById('newPlaylistLoop').value;
    const priority = document.getElementById('newPlaylistPriority').value;

    try {
        const response = await fetch('/api/v1/playlists', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name,
                network_id: networkId,
                loop_mode: loopMode,
                priority: priority
            })
        });

        if (response.ok) {
            const data = await response.json();
            currentPlaylistId = data.id;
            document.getElementById('playlistName').value = name;
            playlistItems = [];
            renderPlaylistItems();
            updateStats();
            closeNewPlaylistModal();

            // Add to sidebar
            addPlaylistToSidebar({
                id: data.id,
                name: name,
                network_id: networkId
            });

            showToast(true, 'Created', `Playlist "${name}" created`);
        } else {
            const err = await response.json();
            showToast(false, 'Error', err.error || 'Failed to create playlist');
        }
    } catch (error) {
        showToast(false, 'Error', error.message);
    }
}

function updatePlaylistName() {
    if (!currentPlaylistId) return;
    const name = document.getElementById('playlistName').value;
    fetch(`/api/v1/playlists/${currentPlaylistId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
    }).then(r => {
        if (r.ok) {
            // Update sidebar name
            const sidebarItem = document.querySelector(`.playlist-item-link[data-id="${currentPlaylistId}"] .playlist-name`);
            if (sidebarItem) sidebarItem.textContent = name;
            showToast(true, 'Updated', 'Playlist name updated');
        } else {
            showToast(false, 'Error', 'Failed to update name');
        }
    }).catch(() => showToast(false, 'Error', 'Connection error'));
}

async function savePlaylist() {
    if (!currentPlaylistId) {
        showToast(false, 'Error', 'No playlist selected. Create a playlist first.');
        return;
    }

    const saveBtn = document.getElementById('savePlaylistBtn');
    const saveIcon = document.getElementById('savePlaylistIcon');
    saveBtn.disabled = true;
    saveIcon.textContent = '‚è≥';

    try {
        // 1. Update playlist name
        const name = document.getElementById('playlistName').value;
        await fetch(`/api/v1/playlists/${currentPlaylistId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });

        // 2. Get existing items from server
        const existingRes = await fetch(`/api/v1/playlists/${currentPlaylistId}`);
        const existingPlaylist = await existingRes.json();
        const existingItems = existingPlaylist.items || [];

        // 3. Delete all existing items (clean slate)
        for (const item of existingItems) {
            await fetch(`/api/v1/playlists/${currentPlaylistId}/items/${item.id}`, {
                method: 'DELETE'
            });
        }

        // 4. Add all current items in order
        for (let i = 0; i < playlistItems.length; i++) {
            const item = playlistItems[i];
            const res = await fetch(`/api/v1/playlists/${currentPlaylistId}/items`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content_id: item.contentId,
                    position: i,
                    duration_override: item.durationOverride || null,
                    source: item.source || (item.syncedContentId ? 'synced' : 'local')
                })
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error || `Failed to add item "${item.title}"`);
            }

            // Update local item with server-assigned ID
            const saved = await res.json();
            playlistItems[i].id = saved.id;
        }

        // 5. Update sidebar item count
        const sidebarItem = document.querySelector(`.playlist-item-link[data-id="${currentPlaylistId}"] .playlist-items-count`);
        if (sidebarItem) sidebarItem.textContent = playlistItems.length;

        saveIcon.textContent = '‚úÖ';
        showToast(true, 'Saved', `Playlist saved with ${playlistItems.length} items`);

        // Reset icon after 2 seconds
        setTimeout(() => { saveIcon.textContent = 'üíæ'; }, 2000);

    } catch (error) {
        saveIcon.textContent = '‚ùå';
        showToast(false, 'Save Failed', error.message);
        setTimeout(() => { saveIcon.textContent = 'üíæ'; }, 2000);
    } finally {
        saveBtn.disabled = false;
    }
}

// ==========================================================================
// Item Settings Modal
// ==========================================================================
function openItemSettings(index) {
    const item = playlistItems[index];
    if (!item) return;

    document.getElementById('itemSettingsIndex').value = index;
    document.getElementById('itemTitle').value = item.title || 'Untitled';
    document.getElementById('itemDuration').value = item.durationOverride || item.duration || 10;

    // Show preview
    const previewEl = document.getElementById('itemPreview');
    if (item.thumbnail) {
        previewEl.innerHTML = `<img src="${item.thumbnail}" style="width: 100%; height: 100%; object-fit: contain;">`;
    } else if (item.type === 'video') {
        previewEl.innerHTML = '<span style="font-size: 48px; color: #4a4a6a;">üé¨</span>';
    } else if (item.type === 'image') {
        previewEl.innerHTML = '<span style="font-size: 48px; color: #4a4a6a;">üñºÔ∏è</span>';
    } else {
        previewEl.innerHTML = '<span style="font-size: 48px; color: #4a4a6a;">üìÑ</span>';
    }

    document.getElementById('itemTriggerModal').classList.add('active');
}

function closeItemTriggerModal() {
    document.getElementById('itemTriggerModal').classList.remove('active');
}

function adjustDuration(delta) {
    const input = document.getElementById('itemDuration');
    let value = parseInt(input.value) || 10;
    value = Math.max(1, Math.min(300, value + delta));
    input.value = value;
}

function saveItemSettings(event) {
    event.preventDefault();
    const index = parseInt(document.getElementById('itemSettingsIndex').value);
    const item = playlistItems[index];
    if (!item) return;

    // Update duration
    const duration = parseInt(document.getElementById('itemDuration').value) || item.duration;
    item.durationOverride = duration;
    item.duration = duration;

    renderPlaylistItems();
    updateStats();
    closeItemTriggerModal();
    showToast(true, 'Saved', 'Item duration updated');
}

// ==========================================================================
// Toast
// ==========================================================================
function showToast(success, title, message) {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = `toast ${success ? 'success' : 'error'}`;
    toast.innerHTML = `
        <span style="font-size: 20px;">${success ? '‚úÖ' : '‚ùå'}</span>
        <div>
            <div style="font-weight: 600; font-size: 14px;">${title}</div>
            <div style="font-size: 13px; color: #6b7280;">${message}</div>
        </div>
    `;
    document.body.appendChild(toast);

    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ==========================================================================
// Content Preview
// ==========================================================================
let previewedContent = null;
let trimStartSeconds = 0;
let trimEndSeconds = 0;
let videoDuration = 0;
let isDragging = null;
let sliderWidth = 0;

function previewContent(element) {
    const id = element.dataset.id;
    const title = element.dataset.title;
    const duration = element.dataset.duration;
    const size = element.dataset.size;
    const filename = element.dataset.filename;
    const type = element.dataset.type;
    const source = element.dataset.source || 'local';

    previewedContent = {
        id: id,
        title: title,
        duration: parseFloat(duration) || 10,
        size: parseInt(size) || 0,
        filename: filename,
        type: type,
        source: source
    };

    // Reset trim values
    trimStartSeconds = 0;
    trimEndSeconds = parseFloat(duration) || 10;
    videoDuration = parseFloat(duration) || 10;

    // Update modal info
    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewDuration').textContent = duration + 's';
    document.getElementById('previewType').textContent = type.charAt(0).toUpperCase() + type.slice(1);
    document.getElementById('previewSize').textContent = formatFileSize(size);

    // Show/hide appropriate controls - video gets trim, everything else gets duration
    const isVideo = type === 'video';
    document.getElementById('trimControls').style.display = isVideo ? 'block' : 'none';
    document.getElementById('durationControls').style.display = isVideo ? 'none' : 'block';

    // Show preview content
    const container = document.getElementById('previewContainer');
    const contentUrl = `/admin/assets/${filename}`;

    if (isVideo) {
        container.innerHTML = `
            <video id="previewVideo" controls style="width: 100%; height: 100%; object-fit: contain;">
                <source src="${contentUrl}" type="video/mp4">
                Your browser does not support video playback.
            </video>
        `;

        // Setup video events
        const video = document.getElementById('previewVideo');
        video.addEventListener('loadedmetadata', function() {
            videoDuration = video.duration;
            trimEndSeconds = videoDuration;
            previewedContent.duration = videoDuration;

            // Update total time display
            document.getElementById('trimTotalTime').textContent = formatTime(videoDuration);
            document.getElementById('trimEndTime').value = formatTime(videoDuration);
            document.getElementById('trimStartTime').value = '00:00';

            // Initialize slider
            setTimeout(() => {
                initTrimSlider();
                updateTrimHandles();
            }, 100);
        });
    } else if (type === 'image') {
        container.innerHTML = `
            <img src="${contentUrl}" alt="${title}" style="width: 100%; height: 100%; object-fit: contain;">
        `;
        document.getElementById('contentDuration').value = previewedContent.duration || 10;
    } else {
        container.innerHTML = `
            <div style="text-align: center; color: #6b7280;">
                <span style="font-size: 64px; display: block; margin-bottom: 16px;">üìÑ</span>
                <p style="margin: 0;">${title}</p>
            </div>
        `;
        document.getElementById('contentDuration').value = previewedContent.duration || 10;
    }

    document.getElementById('contentPreviewModal').classList.add('active');
}

function closeContentPreview() {
    document.getElementById('contentPreviewModal').classList.remove('active');
    // Stop any playing video
    const video = document.querySelector('#previewContainer video');
    if (video) {
        video.pause();
        video.src = '';
    }
    previewedContent = null;
    isDragging = null;
}

// ==========================================================================
// Trim Slider Controls
// ==========================================================================
function initTrimSlider() {
    const container = document.getElementById('trimSliderContainer');
    if (container) {
        sliderWidth = container.offsetWidth - 24; // Account for handle width
    }
}

function startDragHandle(handle, event) {
    event.preventDefault();
    isDragging = handle;

    const moveHandler = (e) => {
        if (!isDragging) return;

        const container = document.getElementById('trimSliderContainer');
        const rect = container.getBoundingClientRect();
        const handleWidth = 24;
        const trackWidth = rect.width - handleWidth;

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        let x = clientX - rect.left;

        // Clamp to track bounds
        x = Math.max(0, Math.min(x, trackWidth));

        // Convert to time
        const percent = x / trackWidth;
        const time = percent * videoDuration;

        if (isDragging === 'start') {
            trimStartSeconds = Math.min(time, trimEndSeconds - 0.5);
            trimStartSeconds = Math.max(0, trimStartSeconds);
        } else {
            trimEndSeconds = Math.max(time, trimStartSeconds + 0.5);
            trimEndSeconds = Math.min(videoDuration, trimEndSeconds);
        }

        updateTrimHandles();
    };

    const upHandler = () => {
        isDragging = null;
        document.removeEventListener('mousemove', moveHandler);
        document.removeEventListener('mouseup', upHandler);
        document.removeEventListener('touchmove', moveHandler);
        document.removeEventListener('touchend', upHandler);
    };

    document.addEventListener('mousemove', moveHandler);
    document.addEventListener('mouseup', upHandler);
    document.addEventListener('touchmove', moveHandler);
    document.addEventListener('touchend', upHandler);
}

function updateTrimHandles() {
    const container = document.getElementById('trimSliderContainer');
    if (!container) return;

    const containerWidth = container.offsetWidth;
    const handleWidth = 24;
    const trackWidth = containerWidth - handleWidth; // Usable track width

    const startPercent = trimStartSeconds / videoDuration;
    const endPercent = trimEndSeconds / videoDuration;

    const startX = startPercent * trackWidth;
    const endX = endPercent * trackWidth;

    // Position handles - start handle at left edge (0), end handle at right edge (containerWidth - handleWidth)
    document.getElementById('trimStartHandle').style.left = startX + 'px';
    document.getElementById('trimEndHandle').style.left = endX + 'px';

    // Update highlight to fill between handles
    const highlight = document.getElementById('trimRangeHighlight');
    highlight.style.left = (startX + handleWidth / 2) + 'px';
    highlight.style.width = (endX - startX) + 'px';

    // Update time inputs
    document.getElementById('trimStartTime').value = formatTime(trimStartSeconds);
    document.getElementById('trimEndTime').value = formatTime(trimEndSeconds);

    // Update duration display
    const selectedDuration = trimEndSeconds - trimStartSeconds;
    document.getElementById('trimDuration').textContent = selectedDuration.toFixed(1) + 's selected';
}

function updateTrimFromInput() {
    const startTime = parseTimeInput(document.getElementById('trimStartTime').value);
    const endTime = parseTimeInput(document.getElementById('trimEndTime').value);

    if (startTime !== null && startTime >= 0 && startTime < trimEndSeconds) {
        trimStartSeconds = Math.min(startTime, videoDuration);
    }

    if (endTime !== null && endTime > trimStartSeconds && endTime <= videoDuration) {
        trimEndSeconds = endTime;
    }

    updateTrimHandles();
}

function setTrimStartFromVideo() {
    const video = document.getElementById('previewVideo');
    if (video && video.currentTime < trimEndSeconds) {
        trimStartSeconds = video.currentTime;
        updateTrimHandles();
    }
}

function setTrimEndFromVideo() {
    const video = document.getElementById('previewVideo');
    if (video && video.currentTime > trimStartSeconds) {
        trimEndSeconds = video.currentTime;
        updateTrimHandles();
    }
}

function previewTrimmedSection() {
    const video = document.getElementById('previewVideo');
    if (video) {
        video.currentTime = trimStartSeconds;
        video.play();

        // Stop at end time
        const checkEnd = setInterval(() => {
            if (video.currentTime >= trimEndSeconds || video.paused) {
                video.pause();
                clearInterval(checkEnd);
            }
        }, 100);
    }
}

function resetTrim() {
    trimStartSeconds = 0;
    trimEndSeconds = videoDuration;
    updateTrimHandles();
}

function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '00:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

function parseTimeInput(timeStr) {
    if (!timeStr) return 0;
    const parts = timeStr.split(':');
    if (parts.length === 2) {
        const mins = parseInt(parts[0]) || 0;
        const secs = parseFloat(parts[1]) || 0;
        return mins * 60 + secs;
    }
    return parseFloat(timeStr) || 0;
}

// ==========================================================================
// Duration Controls (for non-video content)
// ==========================================================================
function adjustContentDuration(delta) {
    const input = document.getElementById('contentDuration');
    let value = parseInt(input.value) || 10;
    value = Math.max(1, Math.min(300, value + delta));
    input.value = value;
}

function addPreviewedContentToPlaylist() {
    if (!previewedContent) return;

    let finalDuration = previewedContent.duration;
    let trimStart = 0;
    let trimEnd = null;

    if (previewedContent.type === 'video') {
        // Use trim values
        finalDuration = trimEndSeconds - trimStartSeconds;
        trimStart = trimStartSeconds;
        trimEnd = trimEndSeconds;
    } else {
        // Use custom duration for images and other content
        finalDuration = parseInt(document.getElementById('contentDuration').value) || 10;
    }

    playlistItems.push({
        id: Date.now().toString(),
        contentId: previewedContent.id,
        syncedContentId: previewedContent.source === 'synced' ? previewedContent.id : null,
        source: previewedContent.source || 'local',
        title: previewedContent.title,
        duration: finalDuration,
        originalDuration: previewedContent.duration,
        trimStart: trimStart,
        trimEnd: trimEnd,
        size: previewedContent.size,
        filename: previewedContent.filename,
        type: previewedContent.type,
        thumbnail: null
    });

    renderPlaylistItems();
    updateStats();
    closeContentPreview();

    const durationInfo = previewedContent.type === 'video' && (trimStart > 0 || trimEnd < videoDuration)
        ? ` (${formatTime(trimStart)} - ${formatTime(trimEnd)})`
        : '';
    showToast(true, 'Added', `"${previewedContent.title}"${durationInfo} added to playlist`);
}

function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Delete playlist
async function deletePlaylist(playlistId, playlistName) {
    if (!confirm(`Are you sure you want to delete "${playlistName}"?\n\nThis action cannot be undone.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/v1/playlists/${playlistId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        });

        if (response.ok) {
            showToast(true, 'Deleted', `"${playlistName}" has been deleted`);
            // Remove from sidebar
            const item = document.querySelector(`.playlist-item-link[data-id="${playlistId}"]`);
            if (item) {
                item.remove();
            }
            // If this was the current playlist, clear the editor
            if (currentPlaylistId === playlistId) {
                currentPlaylistId = null;
                document.getElementById('playlistName').value = 'New Playlist';
                document.getElementById('playlistItems').innerHTML = '';
                updateStats();
            }
        } else {
            const data = await response.json();
            showToast(false, 'Error', data.error || 'Failed to delete playlist');
        }
    } catch (error) {
        showToast(false, 'Error', 'Connection error');
    }
}

// Archive playlist (set is_active = false)
async function archivePlaylist(playlistId, playlistName) {
    if (!confirm(`Archive "${playlistName}"?\n\nArchived playlists won't appear in assignment dropdowns but can be restored later.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/v1/playlists/${playlistId}`, {
            method: 'PUT',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_active: false })
        });

        if (response.ok) {
            showToast(true, 'Archived', `"${playlistName}" has been archived`);
            // Remove from sidebar (archived playlists are hidden)
            const item = document.querySelector(`.playlist-item-link[data-id="${playlistId}"]`);
            if (item) {
                item.remove();
            }
            // If this was the current playlist, clear the editor
            if (currentPlaylistId === playlistId) {
                currentPlaylistId = null;
                document.getElementById('playlistName').value = 'New Playlist';
                document.getElementById('playlistItems').innerHTML = '';
                updateStats();
            }
        } else {
            const data = await response.json();
            showToast(false, 'Error', data.error || 'Failed to archive playlist');
        }
    } catch (error) {
        showToast(false, 'Error', 'Connection error');
    }
}
</script>
{% endblock %}
