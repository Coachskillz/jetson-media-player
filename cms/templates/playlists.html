{% extends "base.html" %}

{% block title %}Playlists - Skillz Media Screens CMS{% endblock %}

{% block extra_styles %}
/* Two-Panel Layout: Content Browser (left) + Playlist Builder (right) */
.layout {
    display: grid;
    grid-template-columns: 1fr 500px;
    gap: 20px;
    margin-top: 20px;
}

.main-content {
    min-width: 0;
}

.playlist-builder-panel {
    position: sticky;
    top: 20px;
    height: fit-content;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
}

/* Content Browser Panel Styles */
.content-browser {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.content-browser h3 {
    font-size: 18px;
    color: #1e293b;
    margin-bottom: 20px;
    font-weight: 700;
}

.content-browser-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.content-browser-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 8px 16px;
    border-radius: 10px;
    border: 2px solid transparent;
    background: #f1f5f9;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
    font-weight: 500;
}

.filter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.filter-btn.active {
    border-color: #667eea;
    background: #eef2ff;
    color: #667eea;
}

.search-input {
    flex: 1;
    min-width: 200px;
    padding: 10px 15px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 14px;
    transition: all 0.2s;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.content-browser-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 15px;
    max-height: 500px;
    overflow-y: auto;
    padding: 5px;
}

.content-browser-item {
    background: #f8fafc;
    border-radius: 12px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
    text-align: center;
}

.content-browser-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-color: #667eea;
}

.content-browser-item .content-icon {
    font-size: 32px;
    margin-bottom: 8px;
}

.content-browser-item .content-name {
    font-size: 12px;
    font-weight: 600;
    color: #1e293b;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.content-browser-item .content-duration {
    font-size: 11px;
    color: #64748b;
    margin-top: 4px;
}

.content-browser-empty {
    text-align: center;
    padding: 40px 20px;
    color: #94a3b8;
}

/* Playlist Builder Panel Styles */
.playlist-builder {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.playlist-builder h3 {
    font-size: 18px;
    color: #1e293b;
    margin-bottom: 20px;
    font-weight: 700;
}

.playlist-builder-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.playlist-selector {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px;
}

.playlist-selector select {
    flex: 1;
    padding: 10px 15px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 14px;
    background: white;
}

.playlist-items-container {
    min-height: 200px;
    max-height: 400px;
    overflow-y: auto;
    border: 2px dashed #e2e8f0;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.2s;
}

.playlist-items-container.drag-over {
    border-color: #667eea;
    background: #f8f9ff;
}

.playlist-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: #f8fafc;
    border-radius: 10px;
    margin: 8px 0;
    cursor: grab;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.playlist-item:hover {
    background: #e0e7ff;
    transform: translateX(4px);
}

.playlist-item.dragging {
    opacity: 0.5;
    border: 2px dashed #667eea;
}

.playlist-item-info {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 10px;
}

.playlist-item-position {
    width: 24px;
    height: 24px;
    background: #667eea;
    color: white;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
}

.playlist-item-title {
    font-weight: 600;
    color: #1e293b;
    font-size: 14px;
}

.playlist-item-duration {
    font-size: 12px;
    color: #64748b;
}

.playlist-item-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.playlist-item-duration-input {
    width: 60px;
    padding: 4px 8px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 12px;
    text-align: center;
}

.playlist-item-remove {
    background: #fee2e2;
    color: #ef4444;
    border: none;
    border-radius: 6px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}

.playlist-item-remove:hover {
    background: #ef4444;
    color: white;
}

.playlist-empty {
    text-align: center;
    padding: 40px 20px;
    color: #94a3b8;
}

.playlist-empty-icon {
    font-size: 48px;
    margin-bottom: 10px;
    opacity: 0.5;
}

.playlist-stats {
    display: flex;
    justify-content: space-between;
    padding: 15px;
    background: #f8fafc;
    border-radius: 10px;
    margin-bottom: 15px;
}

.playlist-stat {
    text-align: center;
}

.playlist-stat-label {
    font-size: 11px;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.playlist-stat-value {
    font-size: 18px;
    font-weight: 700;
    color: #1e293b;
    margin-top: 4px;
}

/* Playlist Settings Section */
.playlist-settings {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.playlist-settings h3 {
    font-size: 16px;
    color: #1e293b;
    margin-bottom: 15px;
    font-weight: 700;
}

/* Legacy styles preserved for backward compatibility */
.preview-panel {
    position: sticky;
    top: 20px;
    height: fit-content;
}

.create-box {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.create-box h3 {
    font-size: 18px;
    color: #1e293b;
    margin-bottom: 20px;
    font-weight: 700;
}

.form-group {
    margin: 15px 0;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #475569;
    font-weight: 600;
    font-size: 14px;
}

.form-group input, .form-group textarea, .form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 14px;
    transition: all 0.2s;
}

.form-group input:focus, .form-group textarea:focus, .form-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 70px;
}

.btn-success {
    background: #10b981;
    color: white;
}

.playlists-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
}

.playlist-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s;
}

.playlist-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.playlist-header {
    margin-bottom: 15px;
}

.playlist-title {
    font-size: 20px;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 8px;
}

.playlist-description {
    color: #64748b;
    font-size: 14px;
    margin-bottom: 12px;
    line-height: 1.5;
}

.trigger-display {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 15px;
}

.trigger-display.default {
    background: #e0e7ff;
    color: #3730a3;
}

.trigger-display.age {
    background: #fce7f3;
    color: #831843;
}

.trigger-display.loyalty {
    background: #d1fae5;
    color: #065f46;
}

.playlist-items {
    border-top: 1px solid #e2e8f0;
    padding-top: 15px;
    max-height: 300px;
    overflow-y: auto;
}

.item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: #f8fafc;
    border-radius: 10px;
    margin: 8px 0;
    cursor: pointer;
    transition: all 0.2s;
}

.item:hover {
    background: #e0e7ff;
    transform: translateX(4px);
}

.item.playing {
    background: #dbeafe;
    border: 2px solid #3b82f6;
}

.item-info {
    flex: 1;
}

.item-title {
    font-weight: 600;
    color: #1e293b;
    font-size: 14px;
}

.item-duration {
    font-size: 12px;
    color: #64748b;
    margin-top: 4px;
}

.empty-playlist {
    text-align: center;
    padding: 30px;
    color: #94a3b8;
    font-size: 14px;
}

#createStatus {
    margin-top: 15px;
    padding: 12px;
    border-radius: 10px;
    display: none;
    font-size: 14px;
    font-weight: 500;
}

.player-box {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.player-box h3 {
    font-size: 16px;
    color: #1e293b;
    margin-bottom: 15px;
    font-weight: 700;
}

.player-container {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
}

.player-container video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.player-info {
    margin-top: 15px;
}

.player-title {
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 10px;
}

.player-meta {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 10px;
}

.meta-item {
    background: #f8fafc;
    padding: 12px;
    border-radius: 8px;
}

.meta-label {
    font-size: 11px;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.meta-value {
    font-size: 14px;
    font-weight: 600;
    color: #1e293b;
    margin-top: 4px;
}

.no-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #94a3b8;
    flex-direction: column;
    padding: 40px 20px;
}

.no-preview svg {
    width: 60px;
    height: 60px;
    margin-bottom: 15px;
    opacity: 0.3;
}

.playlist-progress {
    background: #e2e8f0;
    height: 6px;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 10px;
}

.playlist-progress-fill {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    height: 100%;
    transition: width 0.3s;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-header h3 {
    font-size: 22px;
    color: #1e293b;
    font-weight: 700;
}

.close-btn {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #64748b;
}

.content-selector {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 10px;
}

.content-item {
    padding: 12px;
    border-radius: 8px;
    margin: 5px 0;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.content-item:hover {
    background: #f1f5f9;
}

.content-item.selected {
    background: #dbeafe;
    border: 2px solid #3b82f6;
}

.info-box {
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    padding: 15px 20px;
    border-radius: 12px;
    margin: 20px 0;
}

.info-box p {
    color: #92400e;
    font-size: 14px;
    line-height: 1.6;
    margin: 5px 0;
}
{% endblock %}

{% block content %}
<h2 style="margin: 20px 0 15px 0; color: white; font-size: 24px; font-weight: 700;">üìã Playlist Builder</h2>

<div class="layout">
    <!-- Left Panel: Content Browser -->
    <div class="main-content">
        <div class="content-browser">
            <div class="content-browser-header">
                <h3>üìÇ Content Library</h3>
            </div>

            <!-- Content Filters -->
            <div class="content-browser-filters">
                <button class="filter-btn active" data-type="all" onclick="filterContent('all', this)">All</button>
                <button class="filter-btn" data-type="video" onclick="filterContent('video', this)">üé¨ Video</button>
                <button class="filter-btn" data-type="image" onclick="filterContent('image', this)">üñºÔ∏è Image</button>
                <button class="filter-btn" data-type="audio" onclick="filterContent('audio', this)">üéµ Audio</button>
                <input type="text" class="search-input" id="contentSearch" placeholder="üîç Search content..." oninput="searchContent(this.value)">
            </div>

            <!-- Content Grid -->
            <div class="content-browser-grid" id="contentBrowserGrid">
                <div class="content-browser-empty">
                    <p>Loading approved content...</p>
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="info-box" style="margin-top: 20px;">
            <p><strong>üí° How to Build a Playlist:</strong></p>
            <p><strong>1.</strong> Select a playlist from the dropdown on the right (or create a new one)</p>
            <p><strong>2.</strong> Click on content items above to add them to the playlist</p>
            <p><strong>3.</strong> Drag items to reorder, set durations, then save</p>
        </div>
    </div>

    <!-- Right Panel: Playlist Builder -->
    <div class="playlist-builder-panel">
        <!-- Playlist Builder Section -->
        <div class="playlist-builder">
            <div class="playlist-builder-header">
                <h3>üéØ Playlist Builder</h3>
            </div>

            <!-- Playlist Selector -->
            <div class="playlist-selector">
                <select id="playlistSelect" onchange="loadPlaylistForEdit(this.value)">
                    <option value="">-- Select a Playlist --</option>
                    {% for playlist in playlists %}
                    <option value="{{ playlist.id }}">{{ playlist.name }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-primary" onclick="openCreatePlaylistModal()">+ New</button>
            </div>

            <!-- Playlist Stats -->
            <div class="playlist-stats" id="playlistStats">
                <div class="playlist-stat">
                    <div class="playlist-stat-label">Items</div>
                    <div class="playlist-stat-value" id="statItemCount">0</div>
                </div>
                <div class="playlist-stat">
                    <div class="playlist-stat-label">Total Duration</div>
                    <div class="playlist-stat-value" id="statTotalDuration">0s</div>
                </div>
            </div>

            <!-- Playlist Items Container (Drop Zone) -->
            <div class="playlist-items-container" id="playlistItemsContainer"
                 ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <div class="playlist-empty" id="playlistEmptyState">
                    <div class="playlist-empty-icon">üìã</div>
                    <p>Select a playlist to edit<br>or create a new one</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" id="savePlaylistBtn" onclick="savePlaylistItems()" disabled style="flex: 1;">
                    üíæ Save Changes
                </button>
                <button class="btn" id="previewPlaylistBtn" onclick="previewCurrentPlaylist()" disabled style="flex: 1; background: #64748b; color: white;">
                    ‚ñ∂ Preview
                </button>
            </div>
        </div>

        <!-- Playlist Settings Section (to be populated in subtask 4-5) -->
        <div class="playlist-settings" id="playlistSettingsSection" style="display: none;">
            <h3>‚öôÔ∏è Playlist Settings</h3>
            <!-- Settings form will be added in subtask 4-5 -->
            <p style="color: #94a3b8; font-size: 14px;">Select a playlist to configure settings</p>
        </div>
    </div>
</div>

<!-- Create Playlist Modal -->
<div class="modal" id="createPlaylistModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Playlist</h3>
            <button class="close-btn" onclick="closeCreatePlaylistModal()">&times;</button>
        </div>

        <form id="createPlaylistForm">
            <div class="form-group">
                <label>Playlist Name</label>
                <input type="text" id="playlistName" placeholder="e.g., Store Promotions" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="playlistDescription" placeholder="What is this playlist for?"></textarea>
            </div>

            <div class="form-group">
                <label>Trigger Type</label>
                <select id="triggerType" onchange="updateTriggerValue()">
                    <option value="default">üîÑ Default (Always Playing)</option>
                    <option value="age">üë§ Age Detection</option>
                    <option value="loyalty">‚≠ê Loyalty (Facial Recognition)</option>
                </select>
            </div>

            <div class="form-group" id="triggerValueGroup" style="display: none;">
                <label id="triggerValueLabel">Trigger Value</label>
                <select id="triggerValue">
                    <!-- Options populated by JavaScript -->
                </select>
            </div>

            <button type="submit" class="btn btn-primary">Create Playlist</button>
            <div id="createStatus"></div>
        </form>
    </div>
</div>

<!-- Legacy Add Content Modal (preserved for backward compatibility) -->
<div class="modal" id="addContentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Add Content to Playlist</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>

        <div class="form-group">
            <label>Select Content</label>
            <div class="content-selector" id="contentSelector">
                {% if content %}
                {% for item in content %}
                <div class="content-item" data-id="{{ item.id }}" onclick="selectContent({{ item.id }})">
                    <strong>{{ item.title }}</strong><br>
                    <span style="font-size: 12px; color: #64748b;">{{ item.duration }}s ‚Ä¢ {{ item.filename }}</span>
                </div>
                {% endfor %}
                {% else %}
                <div style="text-align: center; padding: 20px; color: #94a3b8;">
                    No content available. Upload videos first!
                </div>
                {% endif %}
            </div>
        </div>

        <button class="btn btn-primary" onclick="savePlaylistItem()">Add to Playlist</button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // State variables for the two-panel playlist builder
    let currentPlaylistId = null;
    let selectedContentId = null;
    let playlistQueue = [];
    let currentVideoIndex = 0;
    let currentPlaylistName = '';
    let approvedContent = []; // Content items loaded from API
    let currentPlaylistItems = []; // Items in the current playlist being edited
    let currentTypeFilter = 'all';
    let currentSearchQuery = '';

    const triggerValues = {
        age: ['Adult (27-61)', 'Senior (61+)'],
        loyalty: ['Recognized Customer']
    };

    // =====================================================
    // Create Playlist Modal Functions
    // =====================================================

    function openCreatePlaylistModal() {
        document.getElementById('createPlaylistModal').classList.add('active');
    }

    function closeCreatePlaylistModal() {
        document.getElementById('createPlaylistModal').classList.remove('active');
        document.getElementById('playlistName').value = '';
        document.getElementById('playlistDescription').value = '';
        document.getElementById('triggerType').value = 'default';
        document.getElementById('triggerValueGroup').style.display = 'none';
        document.getElementById('createStatus').style.display = 'none';
    }

    function updateTriggerValue() {
        const triggerType = document.getElementById('triggerType').value;
        const triggerValueGroup = document.getElementById('triggerValueGroup');
        const triggerValue = document.getElementById('triggerValue');
        const triggerValueLabel = document.getElementById('triggerValueLabel');

        if (triggerType === 'default') {
            triggerValueGroup.style.display = 'none';
        } else {
            triggerValueGroup.style.display = 'block';

            const options = triggerValues[triggerType] || [];
            triggerValue.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');

            if (triggerType === 'age') {
                triggerValueLabel.textContent = 'Target Age Group';
            } else if (triggerType === 'loyalty') {
                triggerValueLabel.textContent = 'Customer Type';
            }
        }
    }

    document.getElementById('createPlaylistForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('playlistName').value;
        const description = document.getElementById('playlistDescription').value;
        const triggerType = document.getElementById('triggerType').value;
        const triggerValue = triggerType === 'default' ? '' : document.getElementById('triggerValue').value;
        const statusDiv = document.getElementById('createStatus');

        try {
            const response = await fetch('/api/playlists', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name,
                    description,
                    trigger_type: triggerType,
                    trigger_value: triggerValue
                })
            });

            const data = await response.json();

            if (response.ok) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#d1fae5';
                statusDiv.style.color = '#065f46';
                statusDiv.textContent = '‚úÖ Playlist created! Refreshing...';
                setTimeout(() => location.reload(), 1500);
            } else {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#fee2e2';
                statusDiv.style.color = '#991b1b';
                statusDiv.textContent = '‚ùå Failed to create playlist';
            }
        } catch (error) {
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fee2e2';
            statusDiv.style.color = '#991b1b';
            statusDiv.textContent = '‚ùå Error: ' + error.message;
        }
    });

    // =====================================================
    // Content Browser Functions (Left Panel)
    // =====================================================

    async function loadApprovedContent() {
        const grid = document.getElementById('contentBrowserGrid');
        grid.innerHTML = '<div class="content-browser-empty"><p>Loading approved content...</p></div>';

        try {
            const response = await fetch('/api/playlists/approved-content');
            if (!response.ok) throw new Error('Failed to load content');

            approvedContent = await response.json();
            renderContentBrowser();
        } catch (error) {
            grid.innerHTML = `<div class="content-browser-empty"><p>Failed to load content: ${error.message}</p></div>`;
        }
    }

    function renderContentBrowser() {
        const grid = document.getElementById('contentBrowserGrid');

        // Filter content based on type and search
        let filtered = approvedContent;

        if (currentTypeFilter !== 'all') {
            filtered = filtered.filter(item => getContentType(item) === currentTypeFilter);
        }

        if (currentSearchQuery) {
            const query = currentSearchQuery.toLowerCase();
            filtered = filtered.filter(item =>
                item.title.toLowerCase().includes(query) ||
                (item.filename && item.filename.toLowerCase().includes(query))
            );
        }

        if (filtered.length === 0) {
            grid.innerHTML = `
                <div class="content-browser-empty">
                    <p>No ${currentTypeFilter === 'all' ? 'approved' : currentTypeFilter} content found${currentSearchQuery ? ' matching "' + currentSearchQuery + '"' : ''}</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = filtered.map(item => {
            const icon = getContentIcon(item);
            const duration = item.duration ? `${item.duration}s` : '--';
            return `
                <div class="content-browser-item" onclick="addContentToPlaylist(${item.id})" title="${item.title}">
                    <div class="content-icon">${icon}</div>
                    <div class="content-name">${item.title}</div>
                    <div class="content-duration">${duration}</div>
                </div>
            `;
        }).join('');
    }

    function getContentType(item) {
        const filename = (item.filename || '').toLowerCase();
        if (filename.match(/\.(mp4|avi|mov|mkv|webm)$/)) return 'video';
        if (filename.match(/\.(jpg|jpeg|png|gif|webp|bmp)$/)) return 'image';
        if (filename.match(/\.(mp3|wav|ogg|aac)$/)) return 'audio';
        return 'video'; // Default to video
    }

    function getContentIcon(item) {
        const type = getContentType(item);
        switch (type) {
            case 'video': return 'üé¨';
            case 'image': return 'üñºÔ∏è';
            case 'audio': return 'üéµ';
            default: return 'üìÑ';
        }
    }

    function filterContent(type, btn) {
        currentTypeFilter = type;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderContentBrowser();
    }

    function searchContent(query) {
        currentSearchQuery = query;
        renderContentBrowser();
    }

    // =====================================================
    // Playlist Builder Functions (Right Panel)
    // =====================================================

    async function loadPlaylistForEdit(playlistId) {
        currentPlaylistId = playlistId;
        const container = document.getElementById('playlistItemsContainer');
        const saveBtn = document.getElementById('savePlaylistBtn');
        const previewBtn = document.getElementById('previewPlaylistBtn');
        const settingsSection = document.getElementById('playlistSettingsSection');

        if (!playlistId) {
            container.innerHTML = `
                <div class="playlist-empty" id="playlistEmptyState">
                    <div class="playlist-empty-icon">üìã</div>
                    <p>Select a playlist to edit<br>or create a new one</p>
                </div>
            `;
            saveBtn.disabled = true;
            previewBtn.disabled = true;
            settingsSection.style.display = 'none';
            updatePlaylistStats(0, 0);
            return;
        }

        try {
            const response = await fetch(`/api/playlists/${playlistId}/items`);
            if (!response.ok) throw new Error('Failed to load playlist items');

            currentPlaylistItems = await response.json();
            renderPlaylistItems();
            saveBtn.disabled = false;
            previewBtn.disabled = currentPlaylistItems.length === 0;
            settingsSection.style.display = 'block';
        } catch (error) {
            container.innerHTML = `<div class="playlist-empty"><p>Failed to load playlist: ${error.message}</p></div>`;
        }
    }

    function renderPlaylistItems() {
        const container = document.getElementById('playlistItemsContainer');

        if (currentPlaylistItems.length === 0) {
            container.innerHTML = `
                <div class="playlist-empty">
                    <div class="playlist-empty-icon">üìÇ</div>
                    <p>This playlist is empty<br>Click content on the left to add items</p>
                </div>
            `;
            updatePlaylistStats(0, 0);
            return;
        }

        let totalDuration = 0;
        container.innerHTML = currentPlaylistItems.map((item, index) => {
            const duration = item.duration_override || item.duration || 10;
            totalDuration += duration;
            return `
                <div class="playlist-item" draggable="true" data-index="${index}"
                     ondragstart="handleDragStart(event, ${index})"
                     ondragend="handleDragEnd(event)">
                    <div class="playlist-item-info">
                        <div class="playlist-item-position">${index + 1}</div>
                        <div>
                            <div class="playlist-item-title">${item.title || 'Unknown'}</div>
                            <div class="playlist-item-duration">${item.filename || ''}</div>
                        </div>
                    </div>
                    <div class="playlist-item-actions">
                        <input type="number" class="playlist-item-duration-input"
                               value="${duration}" min="1" title="Duration (seconds)"
                               onchange="updateItemDuration(${index}, this.value)">
                        <span style="font-size: 11px; color: #64748b;">sec</span>
                        <button class="playlist-item-remove" onclick="removePlaylistItem(${index})">‚úï</button>
                    </div>
                </div>
            `;
        }).join('');

        updatePlaylistStats(currentPlaylistItems.length, totalDuration);
    }

    function updatePlaylistStats(itemCount, totalDuration) {
        document.getElementById('statItemCount').textContent = itemCount;
        document.getElementById('statTotalDuration').textContent = formatDuration(totalDuration);
    }

    function formatDuration(seconds) {
        if (seconds < 60) return `${seconds}s`;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}m ${secs}s`;
    }

    function addContentToPlaylist(contentId) {
        if (!currentPlaylistId) {
            alert('Please select a playlist first');
            return;
        }

        const content = approvedContent.find(c => c.id === contentId);
        if (!content) return;

        // Add to current items (will be saved when user clicks Save)
        const newItem = {
            content_id: contentId,
            title: content.title,
            filename: content.filename,
            duration: content.duration || 10,
            duration_override: null
        };

        currentPlaylistItems.push(newItem);
        renderPlaylistItems();
        document.getElementById('previewPlaylistBtn').disabled = false;
    }

    function removePlaylistItem(index) {
        currentPlaylistItems.splice(index, 1);
        renderPlaylistItems();
        document.getElementById('previewPlaylistBtn').disabled = currentPlaylistItems.length === 0;
    }

    function updateItemDuration(index, value) {
        const duration = parseInt(value) || 10;
        currentPlaylistItems[index].duration_override = duration;
        // Recalculate total duration
        const totalDuration = currentPlaylistItems.reduce((sum, item) =>
            sum + (item.duration_override || item.duration || 10), 0);
        document.getElementById('statTotalDuration').textContent = formatDuration(totalDuration);
    }

    // =====================================================
    // Drag and Drop Functions (Stub - to be implemented in subtask 4-3)
    // =====================================================

    function handleDragStart(event, index) {
        event.dataTransfer.setData('text/plain', index);
        event.target.classList.add('dragging');
    }

    function handleDragEnd(event) {
        event.target.classList.remove('dragging');
    }

    function handleDragOver(event) {
        event.preventDefault();
        document.getElementById('playlistItemsContainer').classList.add('drag-over');
    }

    function handleDragLeave(event) {
        document.getElementById('playlistItemsContainer').classList.remove('drag-over');
    }

    function handleDrop(event) {
        event.preventDefault();
        document.getElementById('playlistItemsContainer').classList.remove('drag-over');
        // Drag-to-reorder implementation will be added in subtask 4-3
    }

    // =====================================================
    // Save and Preview Functions (Stub)
    // =====================================================

    async function savePlaylistItems() {
        if (!currentPlaylistId) return;

        // Implementation will be completed in subsequent subtasks
        alert('Save functionality will be implemented in subtask 4-3');
    }

    function previewCurrentPlaylist() {
        if (!currentPlaylistId || currentPlaylistItems.length === 0) return;

        // Implementation will be completed in subsequent subtasks
        alert('Preview functionality will be implemented in subtask 4-3');
    }

    async function loadPlaylistItems(playlistId) {
        try {
            const response = await fetch(`/api/playlists/${playlistId}/items`);
            const items = await response.json();

            const container = document.getElementById(`playlist-${playlistId}-items`);

            if (items.length === 0) {
                container.innerHTML = '<div class="empty-playlist">No content added yet</div>';
            } else {
                container.innerHTML = items.map((item, index) => {
                    return `
                        <div class="item" id="item-${playlistId}-${index}" onclick="previewSingleItem('${item.filename}', '${item.title}', ${item.duration}, ${index + 1})">
                            <div class="item-info">
                                <div class="item-title">${index + 1}. ${item.title}</div>
                                <div class="item-duration">${item.duration}s</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        } catch (error) {
            const container = document.getElementById(`playlist-${playlistId}-items`);
            container.innerHTML = '<div class="empty-playlist">Error loading items</div>';
        }
    }

    function previewSingleItem(filename, title, duration, position) {
        const playerContainer = document.getElementById('playerContainer');
        const playerInfo = document.getElementById('playerInfo');

        playerContainer.innerHTML = `
            <video controls autoplay>
                <source src="/cms/uploads/${filename}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        `;

        document.getElementById('playerTitle').textContent = title;
        document.getElementById('playerPosition').textContent = 'Video ' + position;
        document.getElementById('playerTotalDuration').textContent = duration + 's';
        document.getElementById('progressFill').style.width = '0%';

        playerInfo.style.display = 'block';
    }

    async function previewEntirePlaylist(playlistId, playlistName) {
        try {
            const response = await fetch(`/api/playlists/${playlistId}/items`);
            const items = await response.json();

            if (items.length === 0) {
                alert('This playlist is empty! Add content first.');
                return;
            }

            playlistQueue = items;
            currentVideoIndex = 0;
            currentPlaylistName = playlistName;

            const totalDuration = items.reduce((sum, item) => sum + item.duration, 0);
            document.getElementById('playerTotalDuration').textContent = totalDuration + 's total';

            document.getElementById('playerInfo').style.display = 'block';

            playNextVideo(playlistId);
        } catch (error) {
            alert('Failed to load playlist');
        }
    }

    function playNextVideo(playlistId) {
        if (currentVideoIndex >= playlistQueue.length) {
            currentVideoIndex = 0;
        }

        const item = playlistQueue[currentVideoIndex];
        const playerContainer = document.getElementById('playerContainer');

        document.querySelectorAll('.item').forEach(el => el.classList.remove('playing'));
        const currentItem = document.getElementById(`item-${playlistId}-${currentVideoIndex}`);
        if (currentItem) {
            currentItem.classList.add('playing');
            currentItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        playerContainer.innerHTML = `
            <video id="playlistVideo" autoplay>
                <source src="/cms/uploads/${item.filename}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        `;

        const video = document.getElementById('playlistVideo');

        document.getElementById('playerTitle').textContent = `${currentPlaylistName} - ${item.title}`;
        document.getElementById('playerPosition').textContent = `${currentVideoIndex + 1} of ${playlistQueue.length}`;

        const progress = ((currentVideoIndex + 1) / playlistQueue.length) * 100;
        document.getElementById('progressFill').style.width = progress + '%';

        video.addEventListener('ended', () => {
            currentVideoIndex++;
            playNextVideo(playlistId);
        });
    }

    {% for playlist in playlists %}
    loadPlaylistItems({{ playlist.id }});
    {% endfor %}

    function openAddContent(playlistId, playlistName) {
        currentPlaylistId = playlistId;
        document.getElementById('modalTitle').textContent = `Add Content to "${playlistName}"`;
        document.getElementById('addContentModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('addContentModal').classList.remove('active');
        selectedContentId = null;
        document.querySelectorAll('.content-item').forEach(el => el.classList.remove('selected'));
    }

    function selectContent(contentId) {
        selectedContentId = contentId;
        document.querySelectorAll('.content-item').forEach(el => {
            if (el.dataset.id == contentId) {
                el.classList.add('selected');
            } else {
                el.classList.remove('selected');
            }
        });
    }

    async function savePlaylistItem() {
        if (!selectedContentId) {
            alert('Please select content');
            return;
        }

        try {
            const response = await fetch(`/api/playlists/${currentPlaylistId}/items`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    content_id: selectedContentId
                })
            });

            if (response.ok) {
                closeModal();
                loadPlaylistItems(currentPlaylistId);
            }
        } catch (error) {
            alert('‚ùå Error: ' + error.message);
        }
    }

    // =====================================================
    // Page Initialization
    // =====================================================

    // Load approved content for the content browser on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadApprovedContent();
    });
</script>
{% endblock %}
