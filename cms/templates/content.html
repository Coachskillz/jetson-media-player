{% extends "base.html" %}

{% block title %}Content Library - Skillz Media Screens CMS{% endblock %}

{% block extra_styles %}
/* Page Layout: Left Sidebar + Main Content */
.content-library-layout {
    display: grid;
    grid-template-columns: 180px 1fr;
    gap: 24px;
    margin-top: 20px;
    min-height: calc(100vh - 120px);
}

/* Left Sidebar */
.left-sidebar {
    background: white;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    padding: 20px;
    height: fit-content;
}

.sidebar-item {
    padding: 14px 16px;
    margin-bottom: 8px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.sidebar-item:hover {
    background: #f1f5f9;
}

.sidebar-item.active {
    background: #667eea;
    color: white;
}

.sidebar-item.syncing {
    background: #f59e0b;
    color: white;
}

/* Main Content Area */
.main-content-area {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

/* Networks Section */
.networks-section {
    background: white;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    padding: 24px;
}

.networks-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.networks-header h2 {
    font-size: 22px;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
}

/* Network Folders Grid */
.networks-grid {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
}

.network-folder {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 120px;
    text-align: center;
}

.network-folder:hover {
    background: #f8fafc;
    transform: translateY(-2px);
}

.network-folder.active {
    background: #eef2ff;
    border: 2px solid #667eea;
}

.network-folder-icon {
    font-size: 64px;
    margin-bottom: 8px;
    filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.1));
}

.network-folder-name {
    font-size: 13px;
    font-weight: 600;
    color: #1e293b;
    max-width: 100px;
    line-height: 1.3;
}

.network-folder-count {
    font-size: 11px;
    color: #64748b;
    margin-top: 4px;
}

/* All Content Section */
.all-content-section {
    background: white;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    padding: 24px;
    flex: 1;
}

.all-content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.all-content-header h2 {
    font-size: 22px;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
}

/* Search Box */
.search-box {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 8px 14px;
    width: 280px;
}

.search-box input {
    border: none;
    background: transparent;
    font-size: 14px;
    width: 100%;
    outline: none;
}

.search-box:focus-within {
    border-color: #667eea;
}

/* Content Grid */
.content-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 20px;
}

.content-card {
    background: #f8fafc;
    border-radius: 12px;
    padding: 14px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.content-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    border-color: #667eea;
}

.content-card.active {
    border-color: #667eea;
    background: #eef2ff;
}

.content-thumbnail {
    width: 100%;
    height: 110px;
    background: #e2e8f0;
    border-radius: 8px;
    margin-bottom: 10px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.content-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.content-thumbnail .no-thumbnail {
    font-size: 32px;
    color: #94a3b8;
}

.status-badge {
    position: absolute;
    top: 6px;
    right: 6px;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
}

.status-badge.approved { background: #dcfce7; color: #16a34a; }
.status-badge.pending_review { background: #fef3c7; color: #d97706; }
.status-badge.rejected { background: #fee2e2; color: #dc2626; }

.content-title {
    font-size: 14px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.content-meta {
    font-size: 12px;
    color: #64748b;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #64748b;
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 16px;
}

.empty-state h3 {
    font-size: 18px;
    color: #1e293b;
    margin-bottom: 8px;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 16px;
    padding: 28px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.modal-header h3 {
    font-size: 20px;
    color: #1e293b;
    font-weight: 700;
    margin: 0;
}

.close-btn {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #64748b;
}

.close-btn:hover {
    color: #1e293b;
}

/* Form Elements */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #374151;
    font-weight: 600;
    font-size: 14px;
}

.form-group input, .form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
}

.form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: #667eea;
}

/* Icon Picker */
.icon-picker {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 8px;
    margin: 12px 0;
}

.icon-option {
    padding: 10px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
    font-size: 22px;
    transition: all 0.2s;
}

.icon-option:hover {
    border-color: #667eea;
}

.icon-option.selected {
    border-color: #667eea;
    background: #eef2ff;
}

/* Color Picker */
.color-picker {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
    margin: 12px 0;
}

.color-option {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.2s;
}

.color-option:hover {
    transform: scale(1.1);
}

.color-option.selected {
    border-color: #1e293b;
}

/* Buttons */
.btn {
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

/* Toast */
.toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: white;
    padding: 16px 24px;
    border-radius: 10px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 10000;
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.3s ease;
}

.toast.show {
    transform: translateX(0);
    opacity: 1;
}

.toast.success { border-left: 4px solid #10b981; }
.toast.error { border-left: 4px solid #ef4444; }

.toast-icon { font-size: 24px; }
.toast-content h4 { font-size: 14px; color: #1e293b; margin: 0 0 2px 0; }
.toast-content p { font-size: 13px; color: #64748b; margin: 0; }

/* Back Button */
#backButton:hover {
    background: #f1f5f9;
    border-color: #667eea;
    color: #667eea;
}

/* Breadcrumb */
.breadcrumb-item {
    cursor: pointer;
    color: #667eea;
    transition: color 0.2s;
}

.breadcrumb-item:hover {
    color: #4f46e5;
    text-decoration: underline;
}

/* Drag and Drop */
.content-card {
    cursor: grab;
}

.content-card:active {
    cursor: grabbing;
}

.content-card.dragging {
    opacity: 0.5;
    transform: scale(0.95);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.droppable-folder.drag-over {
    background: #eef2ff !important;
    border: 2px dashed #667eea !important;
    transform: scale(1.02);
}

.droppable-folder {
    transition: all 0.2s ease;
    border: 2px solid transparent;
}

.folder-nav-bar.drag-over {
    background: #eef2ff !important;
    border: 2px dashed #667eea !important;
}

{% endblock %}

{% block content %}
<h2 style="margin: 0 0 8px 0; color: white; font-size: 28px; font-weight: 700;">Content Library</h2>

<div class="content-library-layout">
    <!-- Left Sidebar -->
    <div class="left-sidebar">
        <div class="sidebar-item" id="syncBtn" onclick="syncContent()">
            <span id="syncIcon">üîÑ</span> <span id="syncText">Sync</span>
        </div>
        <div class="sidebar-item" onclick="showToast(true, 'Coming Soon', 'Tags feature coming soon!')">
            <span>üè∑Ô∏è</span> Tags
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content-area">
        <!-- Networks Section -->
        <div class="networks-section">
            <div class="networks-header">
                <h2>Networks</h2>
            </div>
            <div class="networks-grid">
                {% for network in networks %}
                <div class="network-folder" data-network="{{ network.slug }}" data-network-id="{{ network.id }}" onclick="selectNetwork('{{ network.slug }}', '{{ network.name }}', '{{ network.id }}')">
                    <div class="network-folder-icon">üìÅ</div>
                    <div class="network-folder-name">{{ network.name }}</div>
                    <div class="network-folder-count" id="count-{{ network.slug }}">0 items</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Folders Section (shown when a network is selected) -->
        <div class="networks-section" id="foldersSection" style="display: none;">
            <div class="networks-header">
                <h2 id="foldersSectionTitle">Folders</h2>
                <button class="btn btn-primary" onclick="openCreateFolder()" style="padding: 8px 16px; font-size: 13px;">
                    + New Folder
                </button>
            </div>
            <!-- Navigation Bar with Back Button and Breadcrumb -->
            <div id="folderNavBar"
                 class="folder-nav-bar"
                 ondragover="handleNavBarDragOver(event)"
                 ondragleave="handleNavBarDragLeave(event)"
                 ondrop="handleNavBarDrop(event)"
                 style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s;">
                <!-- Back Button (hidden at root level) -->
                <button id="backButton" onclick="goBack()" style="display: none; padding: 8px 12px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 14px; color: #374151; transition: all 0.2s;">
                    ‚Üê Back
                </button>
                <!-- Breadcrumb Path -->
                <div id="folderBreadcrumb" style="flex: 1; font-size: 14px; color: #64748b; display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                    <span class="breadcrumb-item" style="cursor: pointer; color: #667eea;" onclick="goToNetworkRoot()">Network</span>
                </div>
                <!-- Drop hint (shown when dragging) -->
                <div id="dropHint" style="display: none; font-size: 12px; color: #667eea; padding: 4px 8px; background: #eef2ff; border-radius: 4px;">
                    Drop here to move to root
                </div>
            </div>
            <div class="networks-grid" id="foldersGrid">
                <!-- Folders will be populated by JavaScript -->
            </div>
        </div>

        <!-- All Content Section -->
        <div class="all-content-section">
            <div class="all-content-header">
                <h2 id="contentSectionTitle">All Content</h2>
                <div class="search-box">
                    <span>üîç</span>
                    <input type="text" id="searchInput" placeholder="Search content..." oninput="searchContent(this.value)">
                </div>
            </div>

            {% if content %}
            <div class="content-grid" id="contentGrid">
                {% for item in content %}
                <div class="content-card"
                     data-id="{{ item.id }}"
                     data-folder="{{ item.folder_id or '' }}"
                     data-networks='{{ item.network_ids|default([])|tojson|safe }}'
                     data-title="{{ item.title }}"
                     data-status="{{ item.status or '' }}"
                     draggable="true"
                     ondragstart="handleContentDragStart(event)"
                     ondragend="handleContentDragEnd(event)"
                     onclick="previewContent('{{ item.id }}', '{{ item.local_filename|default(item.filename) }}', '{{ item.title }}', {{ item.duration }}, {{ item.file_size }})">
                    <div class="content-thumbnail">
                        {% if item.thumbnail_url %}
                        <img src="{{ item.thumbnail_url }}" alt="{{ item.title }}" onerror="this.style.display='none'; this.parentElement.querySelector('.no-thumbnail').style.display='flex';">
                        <div class="no-thumbnail" style="display: none;">
                            {% if item.content_type == 'video' %}üé¨{% elif item.content_type == 'image' %}üñºÔ∏è{% else %}üìÑ{% endif %}
                        </div>
                        {% else %}
                        <div class="no-thumbnail">
                            {% if item.content_type == 'video' %}üé¨{% elif item.content_type == 'image' %}üñºÔ∏è{% else %}üìÑ{% endif %}
                        </div>
                        {% endif %}
                        {% if item.status %}
                        <span class="status-badge {{ item.status }}">{{ item.status|replace('_', ' ') }}</span>
                        {% endif %}
                    </div>
                    <div class="content-title">{{ item.title }}</div>
                    <div class="content-meta">{{ item.duration }}s ‚Ä¢ {{ (item.file_size / 1024 / 1024)|round(1) }} MB</div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üé¨</div>
                <h3>No content available</h3>
                <p>Click Sync to fetch content from the catalog.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal" id="createFolderModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Folder</h3>
            <button class="close-btn" onclick="closeCreateFolder()">&times;</button>
        </div>
        <form id="createFolderForm">
            <div class="form-group">
                <label>Folder Name</label>
                <input type="text" id="folderName" placeholder="e.g., Holiday Specials" required>
            </div>
            <div class="form-group">
                <label>Icon</label>
                <div class="icon-picker">
                    <div class="icon-option selected" data-icon="üìÅ">üìÅ</div>
                    <div class="icon-option" data-icon="üéØ">üéØ</div>
                    <div class="icon-option" data-icon="üì¶">üì¶</div>
                    <div class="icon-option" data-icon="üéÑ">üéÑ</div>
                    <div class="icon-option" data-icon="üéâ">üéâ</div>
                    <div class="icon-option" data-icon="üé¨">üé¨</div>
                    <div class="icon-option" data-icon="‚≠ê">‚≠ê</div>
                    <div class="icon-option" data-icon="üíº">üíº</div>
                </div>
            </div>
            <div class="form-group">
                <label>Color</label>
                <div class="color-picker">
                    <div class="color-option selected" style="background: #667eea;" data-color="#667eea"></div>
                    <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
                    <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                    <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                    <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                    <div class="color-option" style="background: #64748b;" data-color="#64748b"></div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Create Folder</button>
        </form>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal" id="previewModal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 id="previewTitle">Preview</h3>
            <button class="close-btn" onclick="closePreview()">&times;</button>
        </div>
        <div id="previewContainer" style="background: #000; border-radius: 8px; overflow: hidden; position: relative; padding-bottom: 56.25%;">
        </div>
        <div style="margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="background: #f8fafc; padding: 12px; border-radius: 8px;">
                <div style="font-size: 11px; color: #64748b; text-transform: uppercase;">Duration</div>
                <div id="previewDuration" style="font-size: 16px; font-weight: 600; color: #1e293b;">-</div>
            </div>
            <div style="background: #f8fafc; padding: 12px; border-radius: 8px;">
                <div style="font-size: 11px; color: #64748b; text-transform: uppercase;">Size</div>
                <div id="previewSize" style="font-size: 16px; font-weight: 600; color: #1e293b;">-</div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
let currentNetwork = null;
let currentNetworkId = null;
let currentFolder = null;
let folderPath = []; // Track folder navigation path
let searchQuery = '';
let selectedIcon = 'üìÅ';
let selectedColor = '#667eea';
let isSyncing = false;
let currentPreviewId = null;

// Store folders by network from server
let networkFolders = {};

// ==========================================================================
// Sync
// ==========================================================================
async function syncContent() {
    if (isSyncing) return;

    const syncBtn = document.getElementById('syncBtn');
    const syncIcon = document.getElementById('syncIcon');
    const syncText = document.getElementById('syncText');

    isSyncing = true;
    syncBtn.classList.add('syncing');
    syncText.textContent = 'Syncing...';

    try {
        const response = await fetch('/api/v1/content/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        if (response.ok) {
            showToast(true, 'Sync Complete', `${data.synced_count || 0} items synced`);
            if (data.created_count > 0 || data.updated_count > 0) {
                location.reload();
            }
        } else {
            showToast(false, 'Sync Failed', data.error || 'Unknown error');
        }
    } catch (error) {
        showToast(false, 'Sync Failed', error.message);
    } finally {
        isSyncing = false;
        syncBtn.classList.remove('syncing');
        syncText.textContent = 'Sync';
    }
}

// ==========================================================================
// Network/Folder Selection
// ==========================================================================
function selectNetwork(networkSlug, networkName, networkId) {
    currentNetwork = networkSlug;
    currentNetworkId = networkId || null;
    currentFolder = null;
    folderPath = [];

    // Update active state
    document.querySelectorAll('.network-folder').forEach(f => f.classList.remove('active'));
    const selected = document.querySelector(`.network-folder[data-network="${networkSlug || ''}"]`);
    if (selected) selected.classList.add('active');

    // Update title
    document.getElementById('contentSectionTitle').textContent = networkName ? `${networkName} Content` : 'All Content';

    // Show/hide folders section
    const foldersSection = document.getElementById('foldersSection');
    if (networkId) {
        foldersSection.style.display = 'block';
        document.getElementById('foldersSectionTitle').textContent = `${networkName} Folders`;
        loadNetworkFolders(networkId);
        updateBreadcrumb();
        updateBackButton();
    } else {
        foldersSection.style.display = 'none';
    }

    applyFilters();
}

function loadNetworkFolders(networkId) {
    // Fetch folders for this network
    fetch(`/folders?network_id=${networkId}`)
        .then(response => response.json())
        .then(folders => {
            networkFolders[networkId] = folders;
            renderFolders(folders.filter(f => !f.parent_id));
        })
        .catch(error => {
            console.error('Error loading folders:', error);
            renderFolders([]);
        });
}

function renderFolders(folders) {
    const grid = document.getElementById('foldersGrid');

    if (folders.length === 0) {
        grid.innerHTML = `
            <div style="color: #64748b; font-size: 14px; padding: 20px;">
                No folders yet. Click "+ New Folder" to create one.
            </div>
        `;
        return;
    }

    grid.innerHTML = folders.map(folder => `
        <div class="network-folder droppable-folder"
             data-folder="${folder.id}"
             onclick="selectFolder('${folder.id}', '${folder.name}')"
             ondragover="handleFolderDragOver(event)"
             ondragleave="handleFolderDragLeave(event)"
             ondrop="handleFolderDrop(event, '${folder.id}')"
             style="position: relative;">
            <div class="network-folder-icon" style="color: ${folder.color};">${folder.icon}</div>
            <div class="network-folder-name">${folder.name}</div>
            <div class="network-folder-count" id="folder-count-${folder.id}">0 items</div>
            <button onclick="event.stopPropagation(); deleteFolder('${folder.id}', '${folder.name}')"
                    style="position: absolute; top: 4px; right: 4px; background: #fee2e2; border: none; border-radius: 4px; padding: 2px 6px; font-size: 12px; cursor: pointer; color: #dc2626; opacity: 0; transition: opacity 0.2s;"
                    onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0">√ó</button>
        </div>
    `).join('');

    updateFolderCounts();
}

function selectFolder(folderId, folderName) {
    currentFolder = folderId;

    // Add to folder path for breadcrumb
    folderPath.push({ id: folderId, name: folderName });

    // Update breadcrumb and back button
    updateBreadcrumb();
    updateBackButton();

    // Update title
    document.getElementById('contentSectionTitle').textContent = folderName;

    // Load subfolders
    const subfolders = (networkFolders[currentNetworkId] || []).filter(f => f.parent_id === folderId);
    renderFolders(subfolders);

    applyFilters();
}

function goToNetworkRoot() {
    currentFolder = null;
    folderPath = [];
    updateBreadcrumb();
    updateBackButton();

    // Get current network name
    const networkEl = document.querySelector(`.network-folder[data-network-id="${currentNetworkId}"]`);
    const networkName = networkEl ? networkEl.querySelector('.network-folder-name').textContent : 'Network';
    document.getElementById('contentSectionTitle').textContent = `${networkName} Content`;

    // Load root folders for network
    const rootFolders = (networkFolders[currentNetworkId] || []).filter(f => !f.parent_id);
    renderFolders(rootFolders);

    applyFilters();
}

function goBack() {
    if (folderPath.length === 0) {
        // Already at network root, do nothing
        return;
    } else if (folderPath.length === 1) {
        // Go back to network root
        goToNetworkRoot();
    } else {
        // Go back one level
        folderPath.pop();
        const parentFolder = folderPath[folderPath.length - 1];
        currentFolder = parentFolder.id;

        updateBreadcrumb();
        updateBackButton();

        document.getElementById('contentSectionTitle').textContent = parentFolder.name;

        // Load subfolders of parent
        const subfolders = (networkFolders[currentNetworkId] || []).filter(f => f.parent_id === parentFolder.id);
        renderFolders(subfolders);

        applyFilters();
    }
}

function updateBackButton() {
    const backBtn = document.getElementById('backButton');
    if (backBtn) {
        backBtn.style.display = folderPath.length > 0 ? 'block' : 'none';
    }
}

function goToFolder(folderId, index) {
    // Trim path to this folder
    folderPath = folderPath.slice(0, index + 1);
    currentFolder = folderId;

    updateBreadcrumb();
    updateBackButton();

    const folder = folderPath[folderPath.length - 1];
    document.getElementById('contentSectionTitle').textContent = folder.name;

    // Load subfolders
    const subfolders = (networkFolders[currentNetworkId] || []).filter(f => f.parent_id === folderId);
    renderFolders(subfolders);

    applyFilters();
}

function updateBreadcrumb() {
    const breadcrumb = document.getElementById('folderBreadcrumb');
    const networkEl = document.querySelector(`.network-folder[data-network-id="${currentNetworkId}"]`);
    const networkName = networkEl ? networkEl.querySelector('.network-folder-name').textContent : 'Network';

    let html = `<span class="breadcrumb-item" style="cursor: pointer; color: #667eea;" onclick="goToNetworkRoot()">${networkName}</span>`;

    folderPath.forEach((folder, index) => {
        html += ` <span style="color: #94a3b8;">/</span> `;
        if (index === folderPath.length - 1) {
            html += `<span style="color: #1e293b; font-weight: 600;">${folder.name}</span>`;
        } else {
            html += `<span class="breadcrumb-item" style="cursor: pointer; color: #667eea;" onclick="goToFolder('${folder.id}', ${index})">${folder.name}</span>`;
        }
    });

    breadcrumb.innerHTML = html;
}

function updateFolderCounts() {
    const cards = document.querySelectorAll('.content-card');
    const folderCounts = {};

    cards.forEach(card => {
        const folderId = card.dataset.folder;
        if (folderId) {
            folderCounts[folderId] = (folderCounts[folderId] || 0) + 1;
        }
    });

    document.querySelectorAll('.network-folder[data-folder]').forEach(folder => {
        const folderId = folder.dataset.folder;
        const countEl = folder.querySelector('.network-folder-count');
        if (countEl) {
            countEl.textContent = `${folderCounts[folderId] || 0} items`;
        }
    });
}

// ==========================================================================
// Drag and Drop Content to Folders
// ==========================================================================
let draggedContentId = null;
let draggedContentTitle = null;

function handleContentDragStart(event) {
    draggedContentId = event.target.dataset.id;
    draggedContentTitle = event.target.dataset.title;
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', draggedContentId);
}

function handleContentDragEnd(event) {
    event.target.classList.remove('dragging');
    draggedContentId = null;
    draggedContentTitle = null;
    // Remove any lingering drag-over states
    document.querySelectorAll('.droppable-folder').forEach(f => {
        f.classList.remove('drag-over');
    });
}

function handleFolderDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    event.dataTransfer.dropEffect = 'move';
    event.currentTarget.classList.add('drag-over');
}

function handleFolderDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    event.currentTarget.classList.remove('drag-over');
}

async function handleFolderDrop(event, folderId) {
    event.preventDefault();
    event.stopPropagation();
    event.currentTarget.classList.remove('drag-over');

    if (!draggedContentId) return;

    const contentId = draggedContentId;
    const contentTitle = draggedContentTitle;
    const folderName = event.currentTarget.querySelector('.network-folder-name').textContent;

    try {
        const response = await fetch(`/content/${contentId}/move`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ folder_id: folderId })
        });

        if (response.ok) {
            // Update the content card's folder attribute
            const card = document.querySelector(`.content-card[data-id="${contentId}"]`);
            if (card) {
                card.dataset.folder = folderId;
            }

            showToast(true, 'Moved', `"${contentTitle}" moved to "${folderName}"`);
            updateFolderCounts();
            applyFilters();
        } else {
            const err = await response.json();
            showToast(false, 'Error', err.error || 'Failed to move content');
        }
    } catch (error) {
        showToast(false, 'Error', error.message);
    }
}

// Drop on navigation bar to move content to network root (remove from folder)
function handleNavBarDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    event.dataTransfer.dropEffect = 'move';
    document.getElementById('folderNavBar').classList.add('drag-over');
    document.getElementById('dropHint').style.display = 'block';
}

function handleNavBarDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    document.getElementById('folderNavBar').classList.remove('drag-over');
    document.getElementById('dropHint').style.display = 'none';
}

async function handleNavBarDrop(event) {
    event.preventDefault();
    event.stopPropagation();
    document.getElementById('folderNavBar').classList.remove('drag-over');
    document.getElementById('dropHint').style.display = 'none';

    if (!draggedContentId) return;

    const contentId = draggedContentId;
    const contentTitle = draggedContentTitle;

    // Get network name for toast message
    const networkEl = document.querySelector(`.network-folder[data-network-id="${currentNetworkId}"]`);
    const networkName = networkEl ? networkEl.querySelector('.network-folder-name').textContent : 'Network';

    try {
        const response = await fetch(`/content/${contentId}/move`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ folder_id: null })  // null removes from folder
        });

        if (response.ok) {
            // Update the content card's folder attribute
            const card = document.querySelector(`.content-card[data-id="${contentId}"]`);
            if (card) {
                card.dataset.folder = '';
            }

            showToast(true, 'Moved', `"${contentTitle}" moved to ${networkName} root`);
            updateFolderCounts();
            applyFilters();
        } else {
            const err = await response.json();
            showToast(false, 'Error', err.error || 'Failed to move content');
        }
    } catch (error) {
        showToast(false, 'Error', error.message);
    }
}

// ==========================================================================
// Filtering
// ==========================================================================
function searchContent(query) {
    searchQuery = query.toLowerCase();
    applyFilters();
}

function applyFilters() {
    const cards = document.querySelectorAll('.content-card');
    let visibleCount = 0;

    cards.forEach(card => {
        let show = true;

        // Network filter
        if (currentNetwork) {
            const networks = JSON.parse(card.dataset.networks || '[]');
            show = networks.includes(currentNetwork);
        }

        // Folder filter
        if (show) {
            if (currentFolder) {
                // Inside a folder - only show content in that specific folder
                show = card.dataset.folder === currentFolder;
            } else if (currentNetworkId) {
                // At network root level - only show content NOT in any folder
                show = !card.dataset.folder || card.dataset.folder === '';
            }
            // If no network selected (All Networks), show all content regardless of folder
        }

        // Search filter
        if (searchQuery && show) {
            const title = (card.dataset.title || '').toLowerCase();
            show = title.includes(searchQuery);
        }

        card.style.display = show ? 'block' : 'none';
        if (show) visibleCount++;
    });

    updateCounts();
    updateFolderCounts();
}

function updateCounts() {
    const cards = document.querySelectorAll('.content-card');
    const networkCounts = {};

    cards.forEach(card => {
        // Count by network
        const networks = JSON.parse(card.dataset.networks || '[]');
        networks.forEach(n => {
            networkCounts[n] = (networkCounts[n] || 0) + 1;
        });
    });

    // Update network counts
    document.querySelectorAll('.network-folder[data-network]').forEach(folder => {
        const networkSlug = folder.dataset.network;
        const countEl = folder.querySelector('.network-folder-count');
        if (countEl && networkSlug) {
            const count = networkCounts[networkSlug] || 0;
            countEl.textContent = `${count} items`;
        }
    });
}

// ==========================================================================
// Folder Management
// ==========================================================================
function openCreateFolder() {
    if (!currentNetworkId) {
        showToast(false, 'Error', 'Please select a network first');
        return;
    }
    document.getElementById('createFolderModal').classList.add('active');
}

function closeCreateFolder() {
    document.getElementById('createFolderModal').classList.remove('active');
    document.getElementById('folderName').value = '';
}

document.querySelectorAll('.icon-option').forEach(opt => {
    opt.addEventListener('click', function() {
        document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
        this.classList.add('selected');
        selectedIcon = this.dataset.icon;
    });
});

document.querySelectorAll('.color-option').forEach(opt => {
    opt.addEventListener('click', function() {
        document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
        this.classList.add('selected');
        selectedColor = this.dataset.color;
    });
});

document.getElementById('createFolderForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('folderName').value;

    if (!currentNetworkId) {
        showToast(false, 'Error', 'Please select a network first');
        return;
    }

    try {
        const response = await fetch('/folders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name,
                icon: selectedIcon,
                color: selectedColor,
                network_id: currentNetworkId,
                parent_id: currentFolder  // Will be null if at network root
            })
        });

        if (response.ok) {
            const newFolder = await response.json();
            showToast(true, 'Created', 'Folder created!');
            closeCreateFolder();

            // Reload folders for this network
            loadNetworkFolders(currentNetworkId);
        } else {
            const data = await response.json();
            showToast(false, 'Error', data.error);
        }
    } catch (error) {
        showToast(false, 'Error', 'Failed to create folder');
    }
});

async function deleteFolder(folderId, folderName) {
    if (!confirm(`Delete folder "${folderName}"?`)) return;

    try {
        const response = await fetch(`/folders/${folderId}`, { method: 'DELETE' });
        if (response.ok) {
            showToast(true, 'Deleted', 'Folder deleted');
            // Reload folders for this network
            loadNetworkFolders(currentNetworkId);
        } else {
            showToast(false, 'Error', 'Failed to delete');
        }
    } catch (error) {
        showToast(false, 'Error', error.message);
    }
}

// ==========================================================================
// Preview
// ==========================================================================
function previewContent(id, filename, title, duration, fileSize) {
    currentPreviewId = id;
    document.getElementById('previewModal').classList.add('active');
    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewDuration').textContent = duration + 's';
    document.getElementById('previewSize').textContent = (fileSize / 1024 / 1024).toFixed(1) + ' MB';

    const container = document.getElementById('previewContainer');
    const card = document.querySelector(`.content-card[data-id="${id}"]`);
    const contentType = card?.dataset.contentType || 'video';
    const url = '/cms/uploads/' + filename;

    if (contentType === 'image') {
        container.innerHTML = `<img src="${url}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain;">`;
    } else {
        container.innerHTML = `<video controls style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain;"><source src="${url}" type="video/mp4"></video>`;
    }
}

function closePreview() {
    document.getElementById('previewModal').classList.remove('active');
    const video = document.querySelector('#previewContainer video');
    if (video) video.pause();
}

// ==========================================================================
// Toast
// ==========================================================================
function showToast(success, title, message) {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = `toast ${success ? 'success' : 'error'}`;
    toast.innerHTML = `
        <div class="toast-icon">${success ? '‚úÖ' : '‚ùå'}</div>
        <div class="toast-content">
            <h4>${title}</h4>
            <p>${message}</p>
        </div>
    `;
    document.body.appendChild(toast);

    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ==========================================================================
// Init
// ==========================================================================
document.addEventListener('DOMContentLoaded', function() {
    updateCounts();

    // Select the first network by default
    const firstNetwork = document.querySelector('.network-folder[data-network]');
    if (firstNetwork) {
        const slug = firstNetwork.dataset.network;
        const networkId = firstNetwork.dataset.networkId;
        const name = firstNetwork.querySelector('.network-folder-name').textContent;
        selectNetwork(slug, name, networkId);
    }
});
</script>
{% endblock %}
