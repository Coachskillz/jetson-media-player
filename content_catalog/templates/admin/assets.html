{% extends "admin/base.html" %}

{% block title %}Assets - Skillz Media Content Catalog{% endblock %}
{% block page_title %}Content Assets{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" onclick="openUploadModal()">
    <span>+</span> Upload Asset
</button>
{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="stats-row">
    <div class="stat-card">
        <div class="stat-icon">&#128193;</div>
        <div class="stat-value">{{ stats.total }}</div>
        <div class="stat-label">Total Assets</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">&#9998;</div>
        <div class="stat-value">{{ stats.draft }}</div>
        <div class="stat-label">Drafts</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">&#9203;</div>
        <div class="stat-value">{{ stats.pending }}</div>
        <div class="stat-label">Pending Review</div>
    </div>
    <div class="stat-card success">
        <div class="stat-icon">&#10003;</div>
        <div class="stat-value">{{ stats.published }}</div>
        <div class="stat-label">Published</div>
    </div>
</div>

<!-- Filters -->
<div class="filters-bar">
    <form method="GET" class="filters-form">
        <select name="tenant" class="filter-select" onchange="this.form.submit()">
            <option value="">All Retail Partners</option>
            {% for tenant in tenants %}
            <option value="{{ tenant.id }}" {% if tenant_filter == tenant.id|string %}selected{% endif %}>{{ tenant.name }}</option>
            {% endfor %}
        </select>
        <input type="text" name="search" value="{{ search }}" placeholder="Search assets..." class="filter-input">
        <select name="status" class="filter-select">
            <option value="">All Statuses</option>
            <option value="DRAFT" {% if status_filter == 'DRAFT' %}selected{% endif %}>Draft</option>
            <option value="PENDING_REVIEW" {% if status_filter == 'PENDING_REVIEW' %}selected{% endif %}>Pending Review</option>
            <option value="APPROVED" {% if status_filter == 'APPROVED' %}selected{% endif %}>Approved</option>
            <option value="PUBLISHED" {% if status_filter == 'PUBLISHED' %}selected{% endif %}>Published</option>
        </select>
        <button type="submit" class="btn btn-secondary">Filter</button>
    </form>
</div>

<!-- Assets Table -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Retail Partner</th>
                <th>Format</th>
                <th>Size</th>
                <th>Status</th>
                <th>Uploaded</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if assets %}
                {% for asset in assets %}
                <tr class="asset-row {% if asset.status in ['APPROVED', 'PUBLISHED'] %}draggable-asset{% endif %}" {% if asset.status in ['APPROVED', 'PUBLISHED'] %}draggable="true" data-asset-uuid="{{ asset.uuid }}" data-asset-title="{{ asset.title }}" data-asset-filename="{{ asset.filename or asset.file_path }}" data-asset-format="{{ asset.format or 'video' }}" data-asset-size="{{ asset.file_size or 0 }}" data-asset-duration="{{ asset.duration or 0 }}" data-asset-status="{{ asset.status }}" data-asset-tenant="{{ asset.tenant.name if asset.tenant else '' }}" data-asset-tenant-id="{{ asset.tenant.id if asset.tenant else '' }}"{% endif %}>
                    <td>
                        <div class="asset-title">{{ asset.title }}</div>
                        {% if asset.description %}
                        <div class="asset-desc">{{ asset.description[:50] }}{% if asset.description|length > 50 %}...{% endif %}</div>
                        {% endif %}
                    </td>
                    <td>
                        {% if asset.tenant %}
                        <span class="tenant-badge">{{ asset.tenant.name }}</span>
                        {% else %}
                        <span class="tenant-badge unassigned">Unassigned</span>
                        {% endif %}
                    </td>
                    <td><span class="format-badge">{{ asset.format or 'N/A' }}</span></td>
                    <td>{{ (asset.file_size / 1024 / 1024)|round(2) if asset.file_size else 0 }} MB</td>
                    <td><span class="status-badge status-{{ asset.status|lower|replace('_', '-') }}">{{ asset.status }}</span></td>
                    <td>{{ asset.created_at.strftime('%b %d, %Y') if asset.created_at else 'N/A' }}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon" title="Preview" onclick="window.open('/api/v1/assets/{{ asset.id }}/preview', 'VideoPreview', 'width=900,height=600,resizable=yes')">&#9658;</button>
                            <button class="btn-icon" title="Download">&#8595;</button>
                            <button class="btn-icon" title="Edit">&#9998;</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7" class="empty-state">
                        <div class="empty-icon">&#128193;</div>
                        <div class="empty-text">No assets found</div>
                        <button class="btn btn-primary" onclick="openUploadModal()">Upload Your First Asset</button>
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
<div class="pagination">
    {% if pagination.has_prev %}
    <a href="?page={{ pagination.prev_num }}&search={{ search }}&status={{ status_filter }}&tenant={{ tenant_filter }}" class="page-link">&laquo; Prev</a>
    {% endif %}
    <span class="page-info">Page {{ pagination.page }} of {{ pagination.pages }}</span>
    {% if pagination.has_next %}
    <a href="?page={{ pagination.next_num }}&search={{ search }}&status={{ status_filter }}&tenant={{ tenant_filter }}" class="page-link">Next &raquo;</a>
    {% endif %}
</div>
{% endif %}

<!-- Upload Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Upload New Asset</h2>
            <button class="modal-close" onclick="closeUploadModal()">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('admin.upload_asset') }}" enctype="multipart/form-data">
            <div class="form-group">
                <label class="form-label">Retail Partner *</label>
                <div class="tenant-select-wrapper">
                    <select name="tenant_id" id="tenantSelect" class="form-input" required>
                        <option value="">Select Retail Partner...</option>
                        {% for tenant in tenants %}
                        <option value="{{ tenant.id }}">{{ tenant.name }}</option>
                        {% endfor %}
                        <option value="__new__">+ Create New Retail Partner</option>
                    </select>
                </div>
                <div id="newTenantFields" style="display:none; margin-top:12px;">
                    <input type="text" name="new_tenant_name" id="newTenantName" placeholder="New Retail Partner Name" class="form-input">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">File *</label>
                <input type="file" name="file" required accept=".mp4,.mov,.avi,.jpg,.jpeg,.png,.gif,.webp" class="form-input">
                <small class="form-help">Supported: MP4, MOV, AVI, JPG, PNG, GIF (max 500MB)</small>
            </div>
            <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" name="title" placeholder="Asset title (optional, uses filename if empty)" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea name="description" rows="3" placeholder="Brief description..." class="form-input"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <select name="category" class="form-input">
                    <option value="">Select category...</option>
                    <option value="advertisement">Advertisement</option>
                    <option value="promotional">Promotional</option>
                    <option value="informational">Informational</option>
                    <option value="entertainment">Entertainment</option>
                    <option value="ncmec">NCMEC Alert</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Upload Asset</button>
            </div>
        </form>
    </div>
</div>

<style>
.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 24px; }
.stat-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center; }
.stat-card.success { border-color: rgba(16, 185, 129, 0.3); }
.stat-icon { font-size: 24px; margin-bottom: 8px; }
.stat-value { font-size: 32px; font-weight: 700; color: #fff; }
.stat-label { font-size: 13px; color: rgba(255,255,255,0.5); margin-top: 4px; }

.filters-bar { margin-bottom: 24px; }
.filters-form { display: flex; gap: 12px; flex-wrap: wrap; }
.filter-input, .filter-select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 16px; color: #fff; font-size: 14px; }
.filter-input { flex: 1; min-width: 200px; }
.filter-select { min-width: 180px; }

.table-container { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; }
.data-table { width: 100%; border-collapse: collapse; }
.data-table th, .data-table td { padding: 16px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); }
.data-table th { background: rgba(0,0,0,0.2); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(255,255,255,0.5); }
.data-table tr:hover { background: rgba(255,255,255,0.02); }

.asset-title { font-weight: 500; }
.asset-desc { font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 4px; }

.tenant-badge { background: rgba(99, 102, 241, 0.2); color: #818cf8; padding: 4px 10px; border-radius: 20px; font-size: 12px; }
.tenant-badge.unassigned { background: rgba(156, 163, 175, 0.2); color: #9ca3af; }

.format-badge { background: rgba(59, 130, 246, 0.2); color: #60a5fa; padding: 4px 8px; border-radius: 4px; font-size: 12px; text-transform: uppercase; }

.status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
.status-draft { background: rgba(156, 163, 175, 0.2); color: #9ca3af; }
.status-pending-review { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
.status-approved { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
.status-published { background: rgba(16, 185, 129, 0.2); color: #10b981; }

.action-buttons { display: flex; gap: 8px; }
.btn-icon { background: rgba(255,255,255,0.1); border: none; border-radius: 6px; width: 32px; height: 32px; cursor: pointer; color: #fff; font-size: 14px; transition: all 0.2s; }
.btn-icon:hover { background: rgba(255,255,255,0.2); }

.empty-state { text-align: center; padding: 60px 20px !important; }
.empty-icon { font-size: 48px; opacity: 0.3; margin-bottom: 16px; }
.empty-text { color: rgba(255,255,255,0.5); margin-bottom: 20px; }

.pagination { display: flex; justify-content: center; align-items: center; gap: 16px; margin-top: 24px; }
.page-link { color: #00D4AA; text-decoration: none; padding: 8px 16px; border: 1px solid rgba(0,212,170,0.3); border-radius: 6px; }
.page-link:hover { background: rgba(0,212,170,0.1); }
.page-info { color: rgba(255,255,255,0.5); }

.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: #1a1a2e; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.modal-header h2 { font-size: 18px; font-weight: 600; }
.modal-close { background: none; border: none; color: rgba(255,255,255,0.5); font-size: 24px; cursor: pointer; }
.modal-content form { padding: 24px; }
.form-group { margin-bottom: 20px; }
.form-label { display: block; font-size: 13px; font-weight: 500; color: rgba(255,255,255,0.7); margin-bottom: 8px; }
.form-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; color: #fff; font-size: 14px; }
.form-input:focus { outline: none; border-color: #00D4AA; }
textarea.form-input { resize: vertical; }
.form-help { font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 6px; display: block; }
.modal-actions { display: flex; justify-content: flex-end; gap: 12px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); }

.btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; font-size: 14px; }
.btn-primary { background: linear-gradient(135deg, #00D4AA, #00B894); color: #000; }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,212,170,0.3); }
.btn-secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
.btn-secondary:hover { background: rgba(255,255,255,0.15); }

/* Drag and Drop Styles */
.draggable-asset {
    cursor: grab;
    transition: all 0.2s;
}

.draggable-asset:hover {
    background: rgba(0, 212, 170, 0.05) !important;
}

.draggable-asset.dragging {
    opacity: 0.5;
    background: rgba(0, 212, 170, 0.1) !important;
    cursor: grabbing;
}

.asset-row:not(.draggable-asset) {
    opacity: 0.6;
}
</style>

<script>
function openUploadModal() {
    document.getElementById('uploadModal').style.display = 'flex';
}

function closeUploadModal() {
    document.getElementById('uploadModal').style.display = 'none';
}

// Handle "Create New Retail Partner" option
document.getElementById('tenantSelect').addEventListener('change', function() {
    const newFields = document.getElementById('newTenantFields');
    const newNameInput = document.getElementById('newTenantName');
    
    if (this.value === '__new__') {
        newFields.style.display = 'block';
        newNameInput.required = true;
    } else {
        newFields.style.display = 'none';
        newNameInput.required = false;
        newNameInput.value = '';
    }
});

// Close modal on outside click
document.getElementById('uploadModal').addEventListener('click', function(e) {
    if (e.target === this) closeUploadModal();
});

// ==========================================================================
// DRAG AND DROP - Send asset data to CMS
// ==========================================================================

document.querySelectorAll(".draggable-asset").forEach(row => {
    row.addEventListener("dragstart", function(e) {
        this.classList.add("dragging");
        
        const assetData = {
            uuid: this.dataset.assetUuid,
            title: this.dataset.assetTitle,
            filename: this.dataset.assetFilename,
            format: this.dataset.assetFormat,
            file_size: parseInt(this.dataset.assetSize) || 0,
            duration: parseInt(this.dataset.assetDuration) || 0,
            status: this.dataset.assetStatus,
            tenant_name: this.dataset.assetTenant,
            tenant_id: this.dataset.assetTenantId,
            source: "content_catalog"
        };
        
        e.dataTransfer.setData("application/json", JSON.stringify(assetData));
        e.dataTransfer.setData("text/plain", JSON.stringify(assetData));
        e.dataTransfer.effectAllowed = "copy";
        
        console.log("Dragging asset:", assetData.title);
    });
    
    row.addEventListener("dragend", function(e) {
        this.classList.remove("dragging");
    });
});
</script>
{% endblock %}
